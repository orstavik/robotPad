<dom-module id="key-flower">
  <template>
    <style>
      :host {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 20vh;
        height: 20vh;
        position: relative;
        top: 15%;
        left: 25%;
      }

      .leaf {
        display: inline-block;
        box-sizing: border-box;
        width: 80%;
        height: 80%;
        bottom: 50%;
        position: absolute;
        transform-origin: bottom;
        transition-duration: 0.5s;
      }

      .innerLeaf {
        display: inline-block;
        width: 100%;
        height: 100%;
        position: absolute;
        border-top-left-radius: 50%;
        border-bottom-left-radius: 50%;
        border-top-right-radius: 50%;
        transform: rotate(45deg);
        transition-duration: 0.5s;
        box-shadow: 0 0 3px 0px black;
        font-size: 12px;
        color: black;
      }

      #flowerCenter {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 10vh;
        height: 10vh;
        border-radius: 50%;
        background: black;
        box-shadow: 0 0 3px 0 black;
        color: wheat;
        line-height: normal;
        text-align: center;
        font-size: 2vh;
        z-index: 1;
      }

      .note {
        position: absolute;
        left: 50%;
        top: 0%;
        margin-top: 1vh;
        font-size: 3.5vh;
        font-weight: bold;
        transform: translateX(-50%) scaleY(0.75);
      }
    </style>

    <div id="flowerCenter">
      [[scale.key]]
      [[scale.mode]]
    </div>
    <template is="dom-repeat" items="[[coloredScale]]">
      <div class="leaf" style$="transform: rotate([[item.rotation]]deg) scale([[item.scale]]) translateY(-7vh);">
        <div id="tone[[index]]" class="innerLeaf" style$="background: [[item.color]]" on-click="_toneClicked"></div>
        <span class="note">
          [[item.name]]
        </span>
      </div>
    </template>

  </template>

  <script>
    class KeyFlower extends Polymer.Element {
      static get is() {
        return "key-flower";
      }

      static get config() {
        return {
          properties: {
            palette: Object,
            scale: Object,
            coloredScale: {
              type: Array,
              computed: "makeColoredScale(scale, palette)",
              notify: true
            }
          }
        }
      }

      makeColoredScale(scale, palette) {
        if (!scale || !palette)
          return undefined;
        let arr = [];
        for (let i = 0; i < 7; i++) {
          let tonePosition = scale.getTonePosition(i);
          let chordType = scale.getChordType(i);
          let transScale =
            chordType == "maj" ? "0.75, 1" :
              chordType == "min" ? "0.6375, 0.85" :
                chordType == "maj" ? "0.525, 0.7" : "0,0";
          let colorNumber = scale.posInCircleOf5[i];
          arr.push({
            number: tonePosition,
            name: scale.getToneName(i),
            type: chordType,
            color: "hsl(" + Math.round(palette[colorNumber][0]) + ", " + Math.round(palette[colorNumber][1]) + "%, " + Math.round(palette[colorNumber][2]) + "%)",
            scale: transScale,
            rotation: 30 * tonePosition
          });
          arr.sort(function (a, b) {
            return a.number - b.number;
          });
        }
        return arr;
      }

      _toneClicked(e) {
        this.dispatchEvent(new CustomEvent("tone-selected", {detail: {tone: e.target.id}}));
      }
    }
    customElements.define(KeyFlower.is, KeyFlower);
  </script>
</dom-module>