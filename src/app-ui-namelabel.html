<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">

<dom-module id="app-ui-namelabel">
  <template>
    <style>
      #paper {
        display: flex;
        position: absolute;
        bottom: 16px;
        right: 16px;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 3px;
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.5s, transform 0.4s;
      }

      #sketchName {
        margin: 4px 12px;
        font-weight: 400;
      }
    </style>

    <!--todo set the color red when the name has not been persisted, and to green when the data is stored in the db-->
    <template is="dom-if" if="[[uid]]">
        <paper-material id="paper" elevation=1>
          <div hidden$="[[!sketchObject]]" id="sketchName" contenteditable="true" on-pointerdown="_stopProp" on-input="_changeSketchName">[[sketchObject.name]]</div>
          <div hidden$="[[sketchObject]]" on-click="_newSketch">click to make a new sketch</div>
        </paper-material>
    </template>
  </template>
  <script>

    class AppUiNamelabel extends Polymer.Element {
      static get is() {
        return "app-ui-namelabel";
      }

      static get config() {
        return {
          properties: {
            uid: String,
            sketchid: String,
            sketchList: Array,
            sketchObject: {
              type: Object,
              computed:"_makeSketchObject(sketchid, sketchList)"
            }
          }
        }
      }

      _makeSketchObject(sketchid, sketchList){
        if (!sketchid || !sketchList)
          return null;
        let sketchObject = sketchList[sketchid];
        if (!sketchObject)
          return null;
        sketchObject.key = sketchid;
        return sketchObject;
      }

      _newSketch(e) {
        this._fire("new-sketch", this.uid);
      }

      _changeSketchName(e) {
        if (this.nameChanger)
          clearTimeout(this.nameChanger);
        const newName = e.target.innerHTML;
        this.nameChanger = setTimeout(function() {
          this._fire("rename-sketch", {sketch: this.sketchid, user: this.uid, name: newName});
          this.nameChanger = null;
        }.bind(this), 3000);
      }

      _fire(name, detail){
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }

      _stopProp(e){
        e.stopPropagation();
      }
    }
    customElements.define(AppUiNamelabel.is, AppUiNamelabel);
  </script>
</dom-module>