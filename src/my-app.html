<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="color-palette.html">
<link rel="import" href="json-object.html">
<link rel="import" href="droppad-history.html">
<link rel="import" href="json-saver.html">
<link rel="import" href="droppad-canvas.html">
<link rel="import" href="keyboard-listener.html">
<link rel="import" href="music-clef.html">
<link rel="import" href="key-flower.html">
<link rel="import" href="tab-wrapper.html">
<link rel="import" href="app-ui.html">

<dom-module id="my-app">
  <template>

    <style>
      :host {
        display: block;
      }

      json-object {
        display: inline-block;
        width: 250px;
        font-size: 12px;
        line-height: normal;
        position: relative;
        overflow-y: scroll;
        z-index: 1;
      }

      :host {
        --tone-color-0: blue;
        --tone-color-1: red;
        --tone-color-2: yellow;
        --tone-color-3: grey;
        --tone-color-4: orange;
        --tone-color-5: green;
        --tone-color-6: purple;
        --tone-color-7: darkgreen;
        --tone-color-8: brown;
        --tone-color-9: pink;
        --tone-color-10: teal;
        --tone-color-11: magenta;

        --tone-tone-0: blue;
        --tone-tone-1: red;
        --tone-tone-2: yellow;
        --tone-tone-3: grey;
        --tone-tone-4: orange;
        --tone-tone-5: green;
        --tone-tone-6: purple;

        --tone-rotation-0: rotate(0deg);
        --tone-rotation-1: rotate(0deg);
        --tone-rotation-2: rotate(0deg);
        --tone-rotation-3: rotate(0deg);
        --tone-rotation-4: rotate(0deg);
        --tone-rotation-5: rotate(0deg);
        --tone-rotation-6: rotate(0deg);

        --tone-grey-0: hsl(0, 0%, 0%);
        --tone-grey-1: hsl(0, 0%, 9%);
        --tone-grey-2: hsl(0, 0%, 18%);
        --tone-grey-3: hsl(0, 0%, 27%);
        --tone-grey-4: hsl(0, 0%, 36%);
        --tone-grey-5: hsl(0, 0%, 45%);
        --tone-grey-6: hsl(0, 0%, 54%);
        --tone-grey-7: hsl(0, 0%, 63%);
        --tone-grey-8: hsl(0, 0%, 72%);
        --tone-grey-9: hsl(0, 0%, 81%);
        --tone-grey-10: hsl(0, 0%, 90%);
        --tone-grey-11: hsl(0, 0%, 100%);
      }

      #guide {
        display: inline-block;
        padding: 10px;
        font-size: 12px;
        color: grey;
      }

      .button {
        display: inline-block;
        float: left;
        width: 24px;
        height: 24px;
        border: 1px solid grey;
        border-radius: 4px;
        margin: 2px;
        font-size: 11px;
        line-height: 12px;
      }

      .spacer{
        clear: left;
        width: 1px;
      }

      #toolbar {
        left: 0;
        bottom: 0;
        max-width: 80vh;
        position: fixed;
        z-index: 1;
      }
    </style>

    <droppad-canvas id="shapeSelector" drops="[[letters]]" held-keys="[[heldKeys]]" preview="[[preview]]"
                    on-addshapes="_addShapes"
                    on-removeshapes="_removeShapes"
                    on-changeshapes="_changeShapes"
    ></droppad-canvas>

    <div id="toolbar">
      <div class="button spacer"></div>
      <template is="dom-repeat" items="[[coloredScale]]">
        <div id="tone[[index]]" class="button" on-click="setStyleName"
             style$="transform: rotate([[item.rotation]]deg) scale([[item.scale]]);
             background: [[item.color]]; border-radius: 0 50% 50% 50%;">
          [[item.name]]
        </div>
      </template>
      <div class="button spacer" ></div>
      <template is="dom-repeat" items="[[colors]]">
        <div id="color[[index]]" class="button" style$="background: [[item]];" on-click="setStyleName">[[index]]</div>
      </template>
      <div class="button spacer"></div>
      <template is="dom-repeat" items="[0,1,2,3,4,5,6,7,8,9,10,11]">
        <div id="grey[[index]]" class="button" style$="background: var(--tone-grey-[[index]]);"
             on-click="setStyleName">[[index]]
        </div>
      </template>
      <div class="button spacer"></div>
      <div class="button" title="New sketch." on-click="newSketch">New page</div>
      <div class="button" title="ctrl + Click left mouse button on the canvas to create new shape.">New drop</div>
      <div class="button" title="Esc deselects the elements.">Esc</div>
      <div class="button" title="Delete the shape by choosing the shape and pressing 'd'."> d</div>
      <div class="button" title="Move the shape up one layer.">Page Up</div>
      <div class="button" title="Move the shape down one layer.">Page Down</div>
      <div class="button" title="Rotate the shape: hold 'r' + drag it."> r</div>
      <div class="button" title="Resize the shape: hold 'e' + drag it."> e</div>
      <div class="button" title="Resize the shape (while preserving proportions): hold 'e'+'r' + drag it."> e+r</div>
      <div class="button" title="Resize the shape (normalized): hold 'e'+'w' + drag it."> e+w</div>
      <div class="button" title="Mirror the shape: press 'm', coming different mirror modes."> m </div>
      <div class="button" title="Skew the shape: press 'n'"> n</div>
    </div>

    <key-flower id="keyflower" scale="[[scale]]" palette="[[colors]]" colored-scale="{{coloredScale}}"></key-flower>
    <music-clef id="clef" octave="4" mode="major" key="C" scale="{{scale}}"></music-clef>

    <app-ui></app-ui>

    <iron-selector attr-for-selected="select" multi>
      <tab-wrapper title="JSON" select="1">
        <template is="dom-repeat" items="[[letters]]">
          <json-object key="[[item.number]]" obj="[[item]]" on-writeop="writeInChanges"></json-object>
        </template>
      </tab-wrapper>
      <tab-wrapper title="Palette" select="2">
        <color-palette id="palette" css-colors="{{colors}}" on-color-selected="colorSelected"></color-palette>
      </tab-wrapper>
      <tab-wrapper title="Save/Load" select="3">
        <json-saver input="[[letters]]" on-sketchload="loadSketch" json-name="{{sketchName}}"></json-saver>
      </tab-wrapper>
      <tab-wrapper title="History" select="4">
        <droppad-history id="history" on-new-state="_newState" preview="{{preview}}"></droppad-history>
        <!--History: <input type="range" min="0" max="10000" value="0" id="h" on-input="timeTravel"/> <br>-->
      </tab-wrapper>
    </iron-selector>

    <div id="title" style="position: fixed; right: 0">[[sketchName]]</div>

    <keyboard-listener on-key-down="_checkKey" held-keys="{{heldKeys}}"></keyboard-listener>

  </template>

  <script>

    class MyApp extends Polymer.Element {
      static get is() {
        return "my-app";
      }

      static get config() {
        return {
          properties: {
            colors: Array,
            letters: Array,
            coloredScale: {
              type: Array,
              observer: "colorScaleChanged"
            },
            heldKeys: Array,
            sketchName: String,
            preview: Object
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();
      }

      _newState(e){
        this.set("letters", e.detail);
      }

      _addShapes(e){
        this.$.history.add(e.detail);
      }

      _removeShapes(e){
        this.$.history.remove(e.detail);
      }

      _changeShapes(e){
        this.$.history.update(e.detail);
        this.$.shapeSelector.updateSelected();
        //todo this is the problem of updating the selecteds..
      }

      loadSketch(e) {
        this.$.history.setState(e.detail.json);
      }

      newSketch(){
        this.$.history.setState([]);
      }

      writeInChanges(e) {
        this.$.shapeSelector.updateShape(e.target.key, e.detail[e.target.key]);
      }

      _checkKey(e) {
        e.preventDefault();
        if (e.detail.code === "Enter")
          this.$.clef.turnKeyRight();
        else if (e.detail.code === "Tab")
          this.$.clef.turnKeyLeft();
        else if (e.detail.code === "Backspace")
          this.$.clef.turnModusRight();
        else if (e.detail.code === "Backquote")
          this.$.clef.turnModusLeft();
        this.$.shapeSelector.handleKeyPress(e.detail);
      }

      setStyleName(e) {
        this.$.shapeSelector.addStyleToSelected(e.target.id);
      }

      colorScaleChanged() {
        for (let i = 0; i < this.coloredScale.length; i++){
          this.style.setProperty('--tone-tone-' + i, this.coloredScale[i].color);
          this.style.setProperty('--tone-rotation-' + i, "rotate("+this.coloredScale[i].rotation+"deg)");
        }
        for (let i = 0; i < this.colors.length; i++)
          this.style.setProperty('--tone-color-' + i, this.colors[i]);
      }
    }
    customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>

