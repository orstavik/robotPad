<dom-module id="shape-info">
  <template>
    <style>
      :host {
        display: flex;
        position: absolute;
        top: 50%;
        left: 50%;
        cursor: pointer;
      }
    </style>

    <slot></slot>

  </template>
  <script>
    class ShapeInfo extends Polymer.Element {
      static get is() {
        return "shape-info";
      }

      static get config() {
        return {
          properties: {
            mousedown: {
              type: Boolean,
              value: false,
            },
            counter: Number,
            info: {
              type: Object
            },
            matrix: {
              type: Array,
              computed: "calcMatrix(info.matrix.angle, info.matrix.position.x, info.matrix.position.y, info.matrix.scale.x, info.matrix.scale.y)"
            },
            center: Object,
            shift: {
              type: Boolean,
              value: false
            },
            ctrl: {
              type: Boolean,
              value: false
            },
            alt: {
              type: Boolean,
              value: false
            },
            dataSelected: {
              type: Boolean,
              observer: "changeSelected"
            },
            active: {         //we have to have this man in the middle, because changeSelected is called many times even though the value before and after is true many times.
              type: Boolean,
              value: false
            }
          }
        };
      }

      connectedCallback() {
        this.keyListener = this.registerKey.bind(this);
        this.moveListener = this.mouseMove.bind(this);
      }

      changeSelected() {
        if (this.active == this.dataSelected)
          return;
        this.active = this.dataSelected;
        if (this.active)
          this.select();
        else
          this.deselect()
      }

      select() {
        window.addEventListener("keydown", this.keyListener);
        window.addEventListener("keyup", this.keyListener);
        window.addEventListener("mousemove", this.moveListener);
        this.shift = false;
        this.ctrl = false;
        this.alt = false;
      }

      deselect() {
        window.removeEventListener("keydown", this.keyListener);
        window.removeEventListener("keyup", this.keyListener);
        window.removeEventListener("mousemove", this.moveListener);
        this.shift = false;
        this.ctrl = false;
        this.alt = false;
      }

      registerKey(e) {
        let value = (e.type == "keydown");
        switch (e.code) {
          case "KeyR":
            this.shift = value;
            return;
          case "KeyE":
            this.ctrl = value;
            return;
          case "KeyW":
            this.alt = value;
            return;
        }
        if (!value && e.code == "KeyM")
          this.mirror();
        else if (!value && e.code == "KeyT")
          this.info.centered = !this.info.centered;
        this.notifyInfo();
      }

      notifyInfo() {
        this.notifyPath("info");
        this.dispatchEvent(new CustomEvent("info-updated", {detail: this.info}));
      }

      mirror() {
        this.info.matrix.scale.x *= -1;
      };

      mouseMove(e) {
        if (e.which != 1 || !this.active)
          return;

        if (this.ctrl && this.alt)
          this.scaleIt(e.movementX, e.movementY, 1);
        else if (this.ctrl && this.shift)
          this.scaleIt(e.movementX, e.movementY, 2);
        else if (this.ctrl)
          this.scaleIt(e.movementX, e.movementY, 0);
        else if (this.shift)
          this.rotateIt(e.x, e.y, e.movementX, e.movementY);
        else
          this.translateIt(e.movementX, e.movementY);
        this.notifyInfo();
      }

      translateIt(x, y) {
        const matrix = this.info.matrix;
        matrix.position.x += x;
        matrix.position.y += y;
      }

      scaleIt(x, y, constraints) {
        const matrix = this.info.matrix;
        let cos = Math.cos(matrix.angle);
        let sin = Math.sin(matrix.angle);
        let nx = cos * x + sin * y;
        let ny = cos * y - sin * x;
        if (constraints == 1) {
          const max = (matrix.scale.x > matrix.scale.y) ? matrix.scale.x : matrix.scale.y;
          matrix.scale.x = max;
          matrix.scale.y = max;
          nx = -ny;
        }
        if (constraints == 2) {
          let divis = matrix.scale.x / matrix.scale.y;
          nx = -ny * divis;
        }
        matrix.scale.x += nx / 20;
        matrix.scale.y -= ny / 20;
      }

      //2*PI = 360gr
      rotateIt(x, y, dx, dy) {
        this.info.matrix.angle = (2 * Math.PI + (this.info.matrix.angle+dy/50)) % (2 * Math.PI);
      }

      calcMatrix(angle, posX, posY, scX, scY) {
        let matrix = [scX * Math.cos(angle), scX * Math.sin(angle), -scY * Math.sin(angle), scY * Math.cos(angle), posX, posY];
        this.style.transform = "matrix(" + matrix.join(',') + ")";
        return matrix;
      }
    }
    customElements.define(ShapeInfo.is, ShapeInfo);
  </script>
</dom-module>
