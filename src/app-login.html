<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<dom-module id="app-login">
  <template>
    <style>
      :host {
        display: flex;
        box-sizing: border-box;
        width: 350px;
        padding: 25px;
        flex-direction: column;
        align-items: flex-start;
      }

      .headerRow {
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      #accountImage {
        display: flex;
        box-sizing: border-box;
        align-items: center;
        justify-content: center;
        width: 100px;
        height: 100px;
        margin-right: 20px;
      }

      .secondCol {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }

      #accountImage img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 1px solid #cccccc;
      }

      .accountName {
        font-size: 24px;
        font-weight: 300;
        margin-bottom: 6px;
      }

      *[hidden] {
        visibility: hidden;
      }

      paper-button {
        margin: 0;
        text-align: center;
        font-size: 12px;
      }

      paper-button#signIn {
        background-color: var(--paper-indigo-a200);
        color: white;
      }
    </style>

    <firebase-auth id="auth" app-name="droppad" user="{{user}}" provider="google"></firebase-auth>
    <firebase-query id="query" app-name="droppad"></firebase-query>

    <div class="headerRow">
      <div class="firstCol">
        <div id="accountImage">
          <img src="[[_userImage]]" alt="anonymous">
        </div>
      </div>

      <div class="secondCol">
        <div class="accountName">[[_userName]]</div>
        <paper-button id="signIn" raised on-click="_signIn" hidden$="[[_toBool(user)]]">Sign in with Google</paper-button>
        <paper-button raised on-click="_signOut" hidden$="[[!user]]">Sign out</paper-button>
      </div>
    </div>

  </template>
  <script>
    class AppLogin extends Polymer.Element {
      static get is() {
        return "app-login";
      }

      static get config() {
        return {
          properties: {
            user: {
              type: Object,
              observer: "_signInOrOut"
            },
            _userImage: {
              type: String,
              computed: "_setUserImage(user)"
            },
            _userName: {
              type: String,
              computed: "_setUserName(user)"
            },
            _userData: {
              type: String,
              observer: "_newUserData"
            }
          }
        }
      }

      _signIn() {
        return this.$.auth.signInWithPopup();
      }

      _signOut() {
        return this.$.auth.signOut();
      }

      _signInOrOut(user) {
        if (!user) {
          this.dispatchEvent(new CustomEvent("sign-out", {composed: true, bubbles: true}));
          this.set("_userData", null);
          return;
        }

        this.dispatchEvent(new CustomEvent("sign-in", {composed: true, bubbles: true, detail: user}));
        const userDataInDB = firebase.app("droppad").database().ref("/users/" + user.uid);
        userDataInDB.once("value",
          function (success) {
            if (success.exists()) {
              this.set("_userData", success.val());
            } else {
              let startValue = {registered: firebase.database.ServerValue.TIMESTAMP};
              userDataInDB.set(startValue);   //todo no verification that set succeeded or erred
              this.set("_userData", startValue);
            }
          }.bind(this), function (error) {
            console.log("An error occured connecting to DB");
          });

      }

      _newUserData(data) {
        this.dispatchEvent(new CustomEvent("changed-user-data", {composed: true, bubbles: true, detail: data}));
      }

      _setUserName(user) {
        return user ? user.displayName : "Anonymous";
      }

      _setUserImage(user) {
        return user ? user.photoURL : "./images/anonymous.png";
      }

      _toBool(obj) {
        return !!obj;
      }
    }
    customElements.define(AppLogin.is, AppLogin);
  </script>
</dom-module>