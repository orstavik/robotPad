<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="drop-shape.html">
<link rel="import" href="droppad-selector.html">
<link rel="import" href="droppad-canvas-canvas.html">

<dom-module id="droppad-item-marker">
  <template>
    <style>
      :host {
        display: block;
      }

      #marker {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        width: 100px;
        height: 100px;
        border: 2px solid black;
      }
    </style>
    <div id="marker"></div>
  </template>

  <script>
    class DroppadItemMarker extends Polymer.Element {
      static get is() {
        return "droppad-item-marker";
      }

      static get config() {
        return {
          properties: {
            items: {
              type: Array,
              observer: "newSelected"
            }
          }
        }
      }

      newSelected(elems) {
        let boudingRect = ShapeInfoObject.getSurroundingSquare(elems.map(e => e.info));
        this.$.marker.style.left = boudingRect.left + "px";
        this.$.marker.style.top = boudingRect.top + "px";
        this.$.marker.style.width = boudingRect.width + "px";
        this.$.marker.style.height = boudingRect.height + "px";
      }

      connectedCallback() {
        this.addEventListener("pointerdown", this._pointerDown.bind(this));
        this.pointermoveListener = this._pointerMove.bind(this);
        this.pointerupListener = this._pointerUp.bind(this);
      }

      _pointerDown(e) {
        this.lastDown = {x: e.clientX, y: e.clientY};
        this.addEventListener("pointermove", this.pointermoveListener);
        this.addEventListener("pointerup", this.pointerupListener);
        this.setPointerCapture(e.pointerId);
        DroppadItemMarker._cancelPropDefault(e);
      }

      _pointerUp(e) {
        this.lastDown = null;
        this.releasePointerCapture(e.pointerId);
        this.removeEventListener("pointerup", this.pointerupListener);
        this.removeEventListener("pointermove", this.pointermoveListener);
        DroppadItemMarker._cancelPropDefault(e);
      }

      static _cancelPropDefault(e) {
        e.stopPropagation();
        e.preventDefault();
      }

      _pointerMove(e) {
        let detail = {x: e.clientX - this.lastDown.x, y: e.clientY - this.lastDown.y};
        this.dispatchEvent(new CustomEvent("pointer-move", {detail: detail}));
        this.lastDown = {x: e.clientX, y: e.clientY};
        DroppadItemMarker._cancelPropDefault(e);
      }
    }
    customElements.define(DroppadItemMarker.is, DroppadItemMarker);
  </script>
</dom-module>