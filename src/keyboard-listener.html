<dom-module id="keyboard-listener">
  <script>
    class ComplexKeyEvent {
      constructor(prevComplexEvent) {
        prevComplexEvent = prevComplexEvent || {heldKeys: {}, lastUnique: null};
        this.heldKeys = Object.assign({}, prevComplexEvent.heldKeys);
        this.lastUnique = prevComplexEvent;
      }

      down(e) {
        let c = new ComplexKeyEvent(this);
        c.down = e;
        if (this.down.code == c.down.code) {
          c.isRepeat = true;
          c.lastUnique = this.lastUnique;
          return c;
        }
        if (!c.heldKeys[e.code])
          c.heldKeys[e.code] = e;
        return c;
      }

      up(e) {
        let c = new ComplexKeyEvent(this);
        c.up = e;
        c.down = c.heldKeys[e.code];
        if (c.down)
          delete c.heldKeys[e.code];
        return c;
      }

      getDurationToLastDifferent() {
        return this.down.timeStamp - this.lastUnique.timeStamp;
      }

      getDurationDownToUp() {
        return this.up.timeStamp - this.down.timeStamp;
      }

      noHeldKeys() {
        this.heldKeys.length == 0;
      }
    }

    class KeyEvent {
      constructor(code, start, stop) {
        this.code = code;
        this.start = start;
        this.stop = stop;
        this.duration = stop - start;
      }
    }

    class KeyboardListener extends Polymer.Element {
      static get is() {
        return "keyboard-listener";
      }

      static get config() {
        return {
          properties: {
            cachedEvent: ComplexKeyEvent,
          }
        }
      }

      connectedCallback() {
        window.addEventListener("keydown", this._keydown.bind(this));
        window.addEventListener("keyup", this._keyup.bind(this));
        this.cachedEvent = new ComplexKeyEvent(null);
      }

      _keydown(e) {
        KeyboardListener.preventCertainDefaultAction(e);
        let nowEvent = this.cachedEvent.down(e);
        this._fire("key-down", nowEvent);
        if (!nowEvent.isRepeat && this.cachedEvent.noHeldKeys())
          this._fire("key-pause-end", nowEvent);
      }

      _keyup(e) {
        KeyboardListener.preventCertainDefaultAction(e);
        let nowEvent = this.cachedEvent.up(e);
        this._fire("key-up", nowEvent);
        this._fire("key-stroke", nowEvent);
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {"composed": true, "bubbles": true, "detail": detail}));
      }

      static preventCertainDefaultAction(e) {
        let c = e.code;
        if (c == "Tab" || c == "Enter" || c == "ShiftLeft" || c == "Backquote" || c == "Backspace")
          e.preventDefault();
        e.stopPropagation();
      }
    }
    customElements.define(KeyboardListener.is, KeyboardListener);
  </script>
</dom-module>