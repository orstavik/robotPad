<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="drop-shape.html">
<link rel="import" href="color-palette.html">
<link rel="import" href="shape-info.html">
<link rel="import" href="json-object.html">
<link rel="import" href="json-saver.html">
<link rel="import" href="action-log.html">
<link rel="import" href="intertext-selector.html">
<link rel="import" href="keyboard-listener.html">
<link rel="import" href="music-clef.html">
<link rel="import" href="key-flower.html">
<link rel="import" href="tab-wrapper.html">

<dom-module id="my-app">
    <template>

        <style>
            :host {
                display: block;
            }

            json-object {
                display: inline-block;
                width: 250px;
                font-size: 12px;
                line-height: normal;
                height: 100vh;
                position: relative;
                overflow-y: scroll;
                z-index: 1;
            }

            shape-info[data-selected] drop-shape {
                box-shadow: 0 0 3px 0px gold;
            }

            #cross {
                position: absolute;
                bottom: 20%;
                left: 20%;
                width: 60%;
                height: 50%;
                border: 1px dotted black;
                border-right: none;
                border-top: none;
            }
            :host {
                --tone-color-0: blue;
                --tone-color-1: red;
                --tone-color-2: yellow;
                --tone-color-3: grey;
                --tone-color-4: orange;
                --tone-color-5: green;
                --tone-color-6: purple;
                --tone-color-7: darkgreen;
                --tone-color-8: brown;
                --tone-color-9: pink;
                --tone-color-10: teal;
                --tone-color-11: magenta;

                --tone-tone-0: blue;
                --tone-tone-1: red;
                --tone-tone-2: yellow;
                --tone-tone-3: grey;
                --tone-tone-4: orange;
                --tone-tone-5: green;
                --tone-tone-6: purple;
            }

            #guide {
                display: inline-block;
                padding: 10px;
                font-size: 12px;
                color: grey;
            }
            #tone0 {
                position: absolute;
                bottom: 0;
                left: 0;
                width: 20px;
                height: 20px;
                background: darkmagenta;
            }
        </style>

        <!--<json-saver input="[[letters]]" on-sketchload="loadSketch"></json-saver>-->

        <intertext-selector id="shapeSelector" on-select="somethingSelected" on-dblclick="addDropShape">
            <template is="dom-repeat" items="[[letters]]">
                <shape-info id="drop[[index]]" matrix="[[item.matrix]]" counter="[[index]]" data-selectable on-newinfo="anInfoUpdated" style="z-index: [[item.zIndex]]">
                    <drop-shape input="[[item]]"></drop-shape>
                </shape-info>
            </template>
        </intertext-selector>

        <iron-selector attr-for-selected="select" multi>
            <tab-wrapper title="JSON" select="0">
                <json-object key="myLetters" obj="[[letters]]" on-writeop="writeInChanges"></json-object>
            </tab-wrapper>
            <tab-wrapper title="Palette" select="1">
                <color-palette id="palette" computed-colors="{{colors}}" on-color-selected="colorSelected"></color-palette>
            </tab-wrapper>
            <tab-wrapper title="Help" select="2">
                <div id="guide">
                    - Double click left mouse button on the canvas to create shape. <br>
                    - Choose the shape by pressing left mouse button on it (Esc deselects the elements). <br>
                    - Delete the shape by chosing the shape and pressing Del on the keyboard. <br>
                    - Change the shape color by chosing the shape and chosing the color on the top palette. <br>
                    - Change the shape move by chosing the shape and pressing "M" on the keyboard. <br> 
                    - To move the shape one layer above/below pressing "-"/"+" on the keyboard. <br>
                    - Move the shape by pressing left mouse button and moving the mouse. <br>
                    - Rotate the shape by pressing right mouse button and moving the mouse. <br>
                    - Resize the shape by pressing middle mouse button and moving the mouse. <br>
                    - To normalize shape press "Ctrl" when resizing. <br>
                    - To preserve shape proportions press "Shift" when resizing.
                <div>
            </tab-wrapper>
        </iron-selector>

        <!--<key-flower scale="[[scale]]" palette="[[colors]]" colored-scale="{{coloredScale}}" on-tone-selected="_toneSelected" ></key-flower>-->

        <!--<music-clef id="clef" octave="4" mode="major" key="C" scale="{{scale}}"></music-clef>-->

        <div id="tone0" on-click="_toneClicked">0</div>

        <action-log object="[[letters]]" id="log" on-undo="_undo"></action-log>

        <keyboard-listener on-key-down="_checkKey"></keyboard-listener>

    </template>

    <script>

        class MyApp extends Polymer.Element {
            static get is() {
                return "my-app";
            }

            static get config() {
                return {
                    properties: {
                        colors: {
                          type:Array,
                          observer: "colorsChanged"
                        },
                        letters: {
                            type: Array
                        },
                      coloredScale:{
                          type: Array,
                        observer: "colorScaleChanged"
                      }
                    },
                    observers: []
                };
            }

            addDropShape(e) {
                var shape = {
                    style: 0,
                    matrix: {
                        position: {
                            x: e.x,
                            y: e.y
                        },
                        scale: {
                            x: 1,
                            y: 1
                        },
                        angle: 0
                    }
                };
                this.letters.push(shape);
                this.notifyPath("letters");
                //todo how to make it selected when you create it??
            }

          _toneClicked(e){
              let toneClass = e.target.id;
            let node = this.$.shapeSelector.selected;
            this.letters[node.counter].style = toneClass;
            this.notifyPath("letters");
          }

            _undo(e) {
                this.letters = e.detail.state;
            }

            _checkKey(e) {
                if (e.key === "Delete" || e.key === "Backspace")
                    this._deleteElem();
                if (e.key === "Escape")
                  this.$.shapeSelector._deselect(this.$.shapeSelector.selected);

              if (e.code === "KeyM"){
                let drop = this.$.shapeSelector.selected.querySelector("drop-shape");
                drop.centered = !drop.centered;
              }
                if (e.code === "Equal" || e.code === "Minus")
                    this._changeZ(e.code);

              // if (e.code === "KeyZ")
                    // this.$.log.action();
            }

            _deleteElem() {
                for (let i = 0; i < this.letters.length; i++) {
                    if (this.letters[i].selected) {
                        this.letters.splice(i,1);
                    }
                }
                this.notifyPath("letters");
            }
          colorSelected(e){
            let node = this.$.shapeSelector.selected;
            this.letters[node.counter].style = e.detail.color;
            this.notifyPath("letters");
          }
          _toneSelected(e){
            let node = this.$.shapeSelector.selected;
            this.letters[node.counter].style = e.detail.tone;
            this.notifyPath("letters");
          }

          colorScaleChanged(){
            for (let i = 0; i < this.coloredScale.length; i++){
//                debugger;
              this.style.setProperty('--tone-tone-'+i, this.coloredScale[i].color);
            }
          }

          colorsChanged(){
            for (let i = 0; i < this.colors.length; i++){
//                debugger;
              this.style.setProperty('--tone-color-'+i, this.$.palette._computeHSL(this.colors[i]));
            }
          }

          _changeZ(key) {
                if (key === "Equal") {
                    let node = this.$.shapeSelector.selected;
                    node.style.zIndex = node.style.zIndex ? Number(node.style.zIndex)+1 : 1;
                } else if (key === "Minus") {
                    let node = this.$.shapeSelector.selected;
                    if (node.style.zIndex < 1) {
                        let nodes = this.$.shapeSelector.querySelectorAll("shape-info");
                        for (let i = 0; i < nodes.length; i++) {
                            nodes[i].style.zIndex = Number(nodes[i].style.zIndex)+1;
                        }
                        node.style.zIndex = Number(node.style.zIndex)-1;
                    } else {
                        node.style.zIndex = node.style.zIndex ? Number(node.style.zIndex)-1 : 0;
                    }
                }

                let nodes = this.$.shapeSelector.querySelectorAll("shape-info");
                for (let i = 0; i < this.letters.length; i++) {
                    this.letters[i].zIndex = nodes[i].style.zIndex;
                }
                this.notifyPath("letters");
            }

            loadSketch(e) {
                this.letters = JSON.parse(e.detail.json);
                this.notifyPath("letters");
            }

            somethingSelected(e, detail) {
                if (detail.before)
                    this.letters[detail.before.counter].selected = false;
                this.letters[detail.now.counter].selected = true;
                this.notifyPath("letters");
            }
            keyScale(e, detail) {
                var selected = this.$.shapeSelector.selected;
                if (!selected)
                    return console.log("Can't use the keys when no shape is selected");
                selected.scaleAlittle(detail);
                this.notifyPath("letters");
            }
            keyRotate(e, detail) {
                var selected = this.$.shapeSelector.selected;
                if (!selected)
                    return console.log("Can't use the keys when no shape is selected");
                selected.rotateAlittle(detail);
                this.notifyPath("letters");
            }

            anInfoUpdated(e, detail) {
                this.letters[detail.counter].matrix = detail.matrix;
                // this.notifyPath("letters");
            }

            writeInChanges(e, detail) {
//                this.letters = detail[1];
                this.notifyPath("letters");
            }

            connectedCallback() {
                super.connectedCallback();
                var start = '[]';
                this.set("letters", JSON.parse(start));
            }

        }
        customElements.define(MyApp.is, MyApp);
    </script>
</dom-module>

