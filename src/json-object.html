<dom-module id="json-object">
    <template>
        <style>
            div {
                font-weight: lighter;
            }
            div.selected {
                border-left: 10px solid red;
                font-weight: bold;
            }
            .string { color: green; }
            .number { color: blue; }
            .boolean { color: red; }
            .null { color: magenta; }
            .key { color: darkorange; }
        </style>
        <template is="dom-if" if="[[isObject(obj)]]">
            {<br/>
            <div class="jsonObject" style$="padding-left: [[level]]em" class$="[[isSelected(obj)]]">
                <template is="dom-repeat" items="{{_toArray(obj)}}">
                    <template is="dom-if" if="[[!isZero(index)]]">
                        <span>,</span><br />
                    </template>
                    <span>
                        <span class="key">[[item.name]] :</span>
                        <json-object key="[[item.name]]" obj="{{item.value}}" level="[[nextLevel(level)]]" on-edited="childsEdited"></json-object>
                    </span>
                </template>
            </div>
            }
        </template>

        <template is="dom-if" if="[[isArray(obj)]]">
            [
            <template is="dom-repeat" items="[[obj]]">
                <json-object obj="{{item}}" level="[[nextLevel(level)]]"></json-object>,
            </template>
            ]
        </template>

        <template is="dom-if" if="[[isPrimitive(obj)]]">
            <span id="editable" class$="[[getType()]]" contenteditable on-blur="transferEditInDomToPolymerObj">[[obj]]</span>
        </template>
    </template>

    <script>
        Polymer({
            is: 'json-object',

            properties: {
                key: String,
                obj: {
                    type: Object,
                    notify: true
                },
                level: {
                    type :Number,
                    value: 0
                }
            },
            _toArray: function(obj) {
                return Object.keys(obj).map(function(key) {
                    return {
                        name: key,
                        value: obj[key]
                    };
                });
            },
            getType: function () {
                return typeof this.obj;
            },
            isZero: function (index) {
                return index === 0;
            },
            nextLevel: function (level) {
                return level+1;
            },
            isArray: function (obj) {
                return Array.isArray(obj);
            },
            isSelected: function (obj) {
                return !!obj.selected ? "selected" : "";
            },
            isObject: function (obj) {
                return !Array.isArray(obj) && typeof obj === "object";
            },
            isPrimitive: function (obj) {
                return typeof obj !== "object";
            },
            transferEditInDomToPolymerObj: function(e){
                var txt = this.$$("#editable").innerText;
                var myType = this.getType();
                if (myType === "number")
                    this.set("obj", Number(txt));
                else if (myType === "boolean")
                    this.set("obj", Boolean(txt));
                else
                    this.set("obj", txt);
                this.fire("edited", [this.key, this.obj]);
            },
            childsEdited: function(e){
                this.obj[e.detail[0]] = e.detail[1];
                e.detail = [this.key, this.obj];
            }
        });
    </script>
</dom-module>
