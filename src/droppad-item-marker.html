<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="drop-shape.html">
<link rel="import" href="droppad-selector.html">
<link rel="import" href="droppad-canvas-canvas.html">

<dom-module id="droppad-item-marker">
  <template>
    <style>
      :host {
        display: block;
      }

      #marker {
        box-sizing: border-box;
        position: absolute;
        top: 0;
        left: 0;
        margin: -20px;
        border: 1px dotted grey;
      }

      .minimarker {
        position: absolute;
        width: 6px;
        height: 6px;
        background-color: lightgrey;
        border: 1px solid grey;
      }

      #nw {
        top: -4px;
        left: -4px;
      }

      #ne {
        top: -4px;
        right: -4px;
      }

      #sw {
        bottom: -4px;
        left: -4px;
      }

      #se {
        bottom: -4px;
        right: -4px;
      }

      #w {
        top: calc(50% - 4px);
        left: -4px;
        border-radius: 50% 0 0 50%;
      }

      #e {
        top: calc(50% - 4px);
        right: -4px;
        border-radius: 0 50% 50% 0;
      }

      #s {
        bottom: -4px;
        left: calc(50% - 4px);
        border-radius: 0 0 50% 50%;
      }

      #n {
        top: -4px;
        left: calc(50% - 4px);
        border-radius: 50% 50% 0 0;
      }
    </style>
    <div id="marker" hidden$="[[!boundingRect.show]]"
         style$="left: [[boundingRect.left]]px; top: [[boundingRect.top]]px; width:  [[boundingRect.width]]px; height: [[boundingRect.height]]px;">
      <div id="nw" class="minimarker corner"></div>
      <div id="ne" class="minimarker corner"></div>
      <div id="sw" class="minimarker corner"></div>
      <div id="se" class="minimarker corner"></div>
      <div id="w" class="minimarker edge"></div>
      <div id="n" class="minimarker edge"></div>
      <div id="s" class="minimarker edge"></div>
      <div id="e" class="minimarker edge"></div>
      <div id="mover" class="minimarker mover"></div>
      <div id="rotator" class="minimarker rotator"></div>
    </div>
    <template is="dom-repeat" items="[[_clones]]">
      <drop-shape id="copy[[item.number]]" class="copy" info="[[item]]"></drop-shape>
    </template>
  </template>

  <script>
    class MarkerBox {

      static createMarkerSquare(elems, factor) {
        return !elems || !elems.length ? null : new MarkerBox(elems, factor);
      }

      constructor(elems, factor) {
        this.factor = factor;
        this.show = this._addBoxes(elems.map(el => el.info));
      }

      _addBoxes(infos){
        if (!infos || infos.length == 0)
          return false;
        for (let elem of infos)
          this._addBox(elem.getBoundingRect(this.factor));
        this.width = this.right - this.left;
        this.height = this.bottom - this.top;
        return true;
      }

      _addBox(next) {
        this.left = Math.min(this.left || Number.MAX_VALUE, next.left);
        this.top = Math.min(this.top || Number.MAX_VALUE, next.top);
        this.right = Math.max(this.right || -Number.MAX_VALUE, next.right);
        this.bottom = Math.max(this.bottom || -Number.MAX_VALUE, next.bottom);
      }

      start(e){
        this.show = false;
        this.startEvent = e;
      }
    }

    class DroppadItemMarker extends Polymer.Element {
      static get is() {
        return "droppad-item-marker";
      }

      static get config() {
        return {
          properties: {
            items: {
              type: Array,
              observer: "_itemsChanged"
            },
            _clones: Array,
            boundingRect: Object,
            heldkeys: Array,
            zoom: Number
          }
        }
      }

      //todo make intuitive grab handles on the marker.
      //todo fix the rotation of groups of elements.
      //todo fix the scaling of groups of elements.
      //todo many of the functions should have both individual and group values..
      //
      //todo move over the copy and paste functionality

      _itemsChanged(items) {
        this.set("boundingRect", MarkerBox.createMarkerSquare(items, 40));
      }

      connectedCallback() {
        this.$.se.addEventListener("pointerdown", this._pointerDownCorner.bind(this));
        this.$.ne.addEventListener("pointerdown", this._pointerDownCorner.bind(this));
        this.$.sw.addEventListener("pointerdown", this._pointerDownCorner.bind(this));
        this.$.nw.addEventListener("pointerdown", this._pointerDownCorner.bind(this));
        this.$.marker.addEventListener("pointerdown", this._pointerDown.bind(this));
        this.pointermoveListener = this._pointerMove.bind(this);
        this.pointerupListener = this._pointerUp.bind(this);
      }

      _pointerDownCorner(e) {
        this.method = ShapeInfoObject.prototype.scaleMurder;
        this.methodPosition = e.target.id;
        this._pointerDown(e);
      }

      _pointerDown(e) {
        this.set("_clones", this.items.map(el => el.info.clone()));
        this.lastPoint = e;
        this.boundingRect.start(e);
        this.addEventListener("pointermove", this.pointermoveListener);
        this.addEventListener("pointerup", this.pointerupListener);
        this.setPointerCapture(e.pointerId);
        DroppadItemMarker._cancelPropDefault(e);
      }

      _pointerUp(e) {
        this.dispatchEvent(new CustomEvent("changed", {detail: this._clones}));
        this.set("_clones", null);
        this.lastPoint = null;
        this.method = null;
        this.releasePointerCapture(e.pointerId);
        this.removeEventListener("pointerup", this.pointerupListener);
        this.removeEventListener("pointermove", this.pointermoveListener);
        DroppadItemMarker._cancelPropDefault(e);
        setTimeout(function () {
          this.notifyPath("items");
        }.bind(this), 0);
      }

      _pointerMove(e) {
        let movementX = e.clientX - this.lastPoint.clientX;
        let movementY = e.clientY - this.lastPoint.clientY;
        let yMove = movementY / this.zoom;
        let xMove = movementX / this.zoom;
        if (this.method) {
          console.log(this.methodPosition);
          if (this.methodPosition == "se") {
            //this.boundingRect.width += xMove;
            //this.boundingRect.height += yMove;
          }
          let xPercent = xMove / this.boundingRect.width;
          let yPercent = yMove / this.boundingRect.height;
          //todo pass in the top left and bottom right corner of the boundingbox?
          this._clones.map(clone => this.method.call(clone, xMove, yMove));
        } else {
          if (this.heldKeys["KeyE"] && this.heldKeys["KeyW"])
            this._clones.map(clone => clone.scaleRestrict(movementY));
          else if (this.heldKeys["KeyE"] && this.heldKeys["KeyR"])
            this._clones.map(clone => clone.scaleSquare(movementY));
          else if (this.heldKeys["KeyE"])
            this._clones.map(clone => clone.scaleFree(xMove, yMove));
          else if (this.heldKeys["KeyR"])
            this._clones.map(clone => clone.rotate(movementY));
          else
            this._clones.map(clone => clone.move(xMove, yMove));
        }
        this.notifyPath("_clones", this._clones);
        this.lastPoint = e;
        DroppadItemMarker._cancelPropDefault(e);
      }

      static _cancelPropDefault(e) {
        e.stopPropagation();
        e.preventDefault();
      }
    }
    customElements.define(DroppadItemMarker.is, DroppadItemMarker);
  </script>
</dom-module>