<dom-module id="color-palette">
  <template>
    <style>
      :host {
        display: block;
      }

      .color {
        display: block;
        float: left;
        width: 2vh;
        height: 3vh;
        margin: 0;
        padding: 0;
      }
    </style>

    H <input type="range" min="-90" max="90" value="0" id="h" on-input="setSunset"/> <br>
    S <input type="range" min="-100" max="100" value="0" id="s" on-input="setS"/> <br>
    L <input type="range" min="-100" max="100" value="0" id="l" on-input="setL"/> <br>
    <template is="dom-repeat" items="[[cssColors]]">
      <div id="color[[index]]" class="color" style$="background: [[item]]" on-click="_selectColor"></div>
    </template>

  </template>

  <script>
    class ColorPalette extends Polymer.Element {
      static get is() {
        return "color-palette";
      }

      static get config() {
        return {
          properties: {
            staticColors: {
              type: Array,
              value: function () {
                return [
                  [5, 50, 50],
                  [35, 50, 50],
                  [50, 50, 50],
                  [60, 50, 50],
                  [90, 50, 49],
                  [120, 50, 45],
                  [150, 50, 40],
                  [180, 50, 35],
                  [210, 50, 50],
                  [225, 50, 50],
                  [310, 50, 40],
                  [340, 50, 45]
                ]
              }
            },
            computedColors: {
              type: Array,
              computed: "makeComputed(staticColors,l,s, sunset)",
              notify: true
            },
            cssColors: {
              type: Array,
              computed: "makeCSS(computedColors)",
              notify: true,
              observer: "_passOutNewColors"
            },
            s: {
              type: Number,
              value: 0
            },
            l: {
              type: Number,
              value: 0
            },
            sunset: {
              type: Number,
              value: 0
            }
          }
        }
      }

      constructor() {
        super();
        this.blueDistance = -60;
        this.redDistance = 60;
        this.greenDistance = 39;
      }

      _passOutNewColors(cssColors){
        this.dispatchEvent(new CustomEvent("new-colors", {composed: true, bubbles: true, detail: cssColors}));
      }

      _selectColor(e) {
        this.dispatchEvent(new CustomEvent("select-color", {composed: true, bubbles: true, detail: e.target.id}));
      }

      makeComputed(staticColors, l, s, sunset) {
        return staticColors.map(function (item) {
          return this.calculateRGB(ColorPalette.calculateHSL(item, s, l), sunset / 100);
        }.bind(this));
      }

      makeCSS(computedColors) {
        return computedColors.map(function(color){
          return ColorPalette._computeHSL(color);
        });
      }

      calculateRGB(hsl, degreeSunset) {
        let rgb = ColorPalette.hslToRgb(hsl[0] / 360, hsl[1] / 100, hsl[2] / 100);
        let addBlue = Math.sin(degreeSunset) * this.blueDistance / Math.sin(90 - degreeSunset);
        let addGreen = Math.sin(degreeSunset) * this.greenDistance / Math.sin(90 - degreeSunset);
        let addRed = Math.sin(degreeSunset) * this.redDistance / Math.sin(90 - degreeSunset);
        return ColorPalette.rgbToHsl(
          rgb[0] * (1 + addRed),
          rgb[1] * (1 + addGreen),
          rgb[2] * (1 + addBlue)
        );
      }

      static calculateHSL(item, s, l) {
        return [
          item[0],
          item[1] + (s >= 0 ? (100 - item[1]) * s : item[1] * s),
          item[2] + (l >= 0 ? (100 - item[2]) * l : item[2] * l)
        ];
      }

      static _computeHSL(item) {
        return "hsl(" + Math.round(item[0]) + "," + Math.round(item[1]) + "%," + Math.round(item[2]) + "%)";
      }

      setS(e) {
        this.s = Number(e.target.value) / 100;
      }

      setL(e) {
        this.l = Number(e.target.value) / 100;
      }

      setSunset(e) {
        this.sunset = Number(e.target.value) / 100;
      }

      /**
       * Converts an RGB color value to HSL. Conversion formula
       * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
       * Assumes r, g, and b are contained in the set [0, 255] and
       * returns h, s, and l in the set [0, 1].
       *
       * @param   Number  r       The red color value
       * @param   Number  g       The green color value
       * @param   Number  b       The blue color value
       * @return  Array           The HSL representation
       */
      static rgbToHsl(r, g, b) {
        r /= 255, g /= 255, b /= 255;
        var max = Math.max(r, g, b), min = Math.min(r, g, b);
        var h, s, l = (max + min) / 2;

        if (max == min) {
          h = s = 0; // achromatic
        } else {
          var d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          switch (max) {
            case r:
              h = (g - b) / d + (g < b ? 6 : 0);
              break;
            case g:
              h = (b - r) / d + 2;
              break;
            case b:
              h = (r - g) / d + 4;
              break;
          }
          h /= 6;
        }

        return [h * 360, s * 100, l * 100];
      }


      /**
       * Converts an HSL color value to RGB. Conversion formula
       * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
       * Assumes h, s, and l are contained in the set [0, 1] and
       * returns r, g, and b in the set [0, 255].
       *
       * @param   Number  h       The hue
       * @param   Number  s       The saturation
       * @param   Number  l       The lightness
       * @return  Array           The RGB representation
       */
      static hslToRgb(h, s, l) {
        var r, g, b;

        if (s == 0) {
          r = g = b = l; // achromatic
        } else {
          function hue2rgb(p, q, t) {
            if (t < 0) t += 1;
            if (t > 1) t -= 1;
            if (t < 1 / 6) return p + (q - p) * 6 * t;
            if (t < 1 / 2) return q;
            if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
            return p;
          }

          var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
          var p = 2 * l - q;
          r = hue2rgb(p, q, h + 1 / 3);
          g = hue2rgb(p, q, h);
          b = hue2rgb(p, q, h - 1 / 3);
        }

        return [r * 255, g * 255, b * 255];
      }
    }
    customElements.define(ColorPalette.is, ColorPalette);
  </script>
</dom-module>