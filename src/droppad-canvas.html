<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="droppad-canvas">
  <template>
    <style>
      :host {
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        top: 0;
        width: 100vw;
        height: 100vh;
      }

      #crossX, #crossY, #pastePosition {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
      }

      #crossX {
        height: 50%;
        width: 100%;
        border-bottom: 1px dashed lightgray;
      }

      #crossY {
        width: 50%;
        height: 100%;
        border-right: 1px dashed lightgray;
      }

      #pastePosition {
        margin-top: 50vh;
        margin-left: 50vw;
        width: 7px;
        height: 7px;
        border-right: 2px dotted red;
        border-bottom: 2px dotted red;
      }

    </style>
    <iron-selector id="dropSelector" on-click="singleSelect" selectable="shape-info" selected-attribute="data-selected"
                   selected-values="{{selectedDropsNum}}" selected-items="{{selectedDrops}}" multi>
      <slot></slot>
    </iron-selector>
    <div id="crossX"></div>
    <div id="crossY"></div>
    <div id="pastePosition" style$="top: [[position.1]]px; left: [[position.0]]px"></div>
  </template>

  <script>
    class DroppadCanvas extends Polymer.Element {
      static get is() {
        return "droppad-canvas";
      }

      static get config() {
        return {
          properties: {
            selectedDropsNum: Array,
            selectedDrops: {
              type: Array,
              notify: true,
              reflectToAttribute: true
            }
          }
        }
      }

      connectedCallback() {
        this.addEventListener("click", this._singleClick.bind(this));
//        this.addEventListener("dblclick", this._doubleClick.bind(this));
        window.addEventListener("keydown", this._registerKey.bind(this));
      }

      _registerKey(e) {
        if (e.code === "Escape")
          this.deSelect();
        else if (e.code === "KeyD")
          this._deleteElem();
        else if (e.code === "KeyC")
          this.copiedShapes = this.selectedDrops.slice();
        else if (e.code === "KeyV") {
          for (let i = 0; i < this.copiedShapes.length; i++)
            this._addShape(this.copiedShapes[i].info);
        }
      }

      _deleteElem() {
        this.dispatchEvent(new CustomEvent("delete", {detail: this.selectedDrops}));
        this.deSelect();
      }

      //this is a fix of the lack of shift+click in the multi iron selector.
      singleSelect(e) {
        //skip no selected
        if (!this.selectedDropsNum || this.selectedDropsNum.length == 0)
          return;
        //use normal behaviour when shift is held down
        if (e.shiftKey)
          return;
        //one element selected, and that is the one clicked, it should be deselected by the default logic
        if (this.selectedDropsNum.length == 1 && e.target.parentElement == this.selectedDrops[0])
          return;
        this.deSelect();
        //somehow this is enough, the iron selector looks to wait till last until it updates its selectedVALUES (not items)
      }

      deSelect() {
        this.selectedDropsNum = [];
        this.notifyPath("selectedDrops");
      }

      _addShape(info) {
        this._makeShape(info.makeCopy(this.position[0], this.position[1]));
      };

      _singleClick(e) {
        this.position = [e.x - window.innerWidth / 2, e.y - window.innerHeight / 2];
        if (e.ctrlKey) {
          this._makeShape(new ShapeInfoObject(this.position[0], this.position[1]));
          //todo make this one selected
          return;
        }
        if (e.target == this) {
          this.deSelect();
          return;
        }
      }

//      _doubleClick(e) {
//        this._makeShape(new ShapeInfoObject(this.position[0], this.position[1]));
//      }

      _makeShape(shapeInfoObj) {
        this.dispatchEvent(new CustomEvent("new", {detail: shapeInfoObj}));
      }
    }
    customElements.define(DroppadCanvas.is, DroppadCanvas);
  </script>
</dom-module>