<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="drop-shape.html">
<link rel="import" href="color-palette.html">
<link rel="import" href="shape-info.html">
<link rel="import" href="json-object.html">
<link rel="import" href="json-saver.html">
<link rel="import" href="action-log.html">
<link rel="import" href="droppad-canvas.html">
<link rel="import" href="keyboard-listener.html">
<link rel="import" href="music-clef.html">
<link rel="import" href="key-flower.html">
<link rel="import" href="tab-wrapper.html">

<dom-module id="my-app">
  <template>

    <style>
      :host {
        display: block;
      }

      json-object {
        display: inline-block;
        width: 250px;
        font-size: 12px;
        line-height: normal;
        height: 100vh;
        position: relative;
        overflow-y: scroll;
        z-index: 1;
      }

      shape-info[data-selected] drop-shape {
        box-shadow: 0 0 3px 0px black;
      }

      :host {
        --tone-color-0: blue;
        --tone-color-1: red;
        --tone-color-2: yellow;
        --tone-color-3: grey;
        --tone-color-4: orange;
        --tone-color-5: green;
        --tone-color-6: purple;
        --tone-color-7: darkgreen;
        --tone-color-8: brown;
        --tone-color-9: pink;
        --tone-color-10: teal;
        --tone-color-11: magenta;

        --tone-tone-0: blue;
        --tone-tone-1: red;
        --tone-tone-2: yellow;
        --tone-tone-3: grey;
        --tone-tone-4: orange;
        --tone-tone-5: green;
        --tone-tone-6: purple;

        --tone-rotation-0: rotate(0deg);
        --tone-rotation-1: rotate(0deg);
        --tone-rotation-2: rotate(0deg);
        --tone-rotation-3: rotate(0deg);
        --tone-rotation-4: rotate(0deg);
        --tone-rotation-5: rotate(0deg);
        --tone-rotation-6: rotate(0deg);
      }

      #guide {
        display: inline-block;
        padding: 10px;
        font-size: 12px;
        color: grey;
      }
    </style>


    <droppad-canvas id="shapeSelector" selected-drops="{{selected}}" on-new-drop="addDropShape" on-del-drops="_delDrops" center="{{center}}">
        <template is="dom-repeat" items="[[letters]]">
          <shape-info id="drop[[index]]" info="[[item]]" counter="[[index]]" center="[[center]]"
                      on-info-updated="notifyLetters" style="z-index: [[item.zIndex]]">
            <drop-shape input="[[item]]" centered$="[[item.centered]]"></drop-shape>
          </shape-info>
        </template>
    </droppad-canvas>

    <iron-selector attr-for-selected="select" multi>
      <tab-wrapper title="JSON" select="0">
        <json-object key="myLetters" obj="[[letters]]" on-writeop="writeInChanges"></json-object>
      </tab-wrapper>
      <tab-wrapper title="Palette" select="1">
        <color-palette id="palette" css-colors="{{colors}}" on-color-selected="colorSelected"></color-palette>
      </tab-wrapper>
      <tab-wrapper title="Flower" select="2">
        <key-flower id="keyflower" scale="[[scale]]" palette="[[colors]]" colored-scale="{{coloredScale}}"
                    on-tone-selected="_toneSelected"></key-flower>
        <music-clef id="clef" octave="4" mode="major" key="C" scale="{{scale}}"></music-clef>
      </tab-wrapper>
      <tab-wrapper title="Save/Load" select="3">
        <json-saver input="[[letters]]" on-sketchload="loadSketch"></json-saver>
      </tab-wrapper>
      <tab-wrapper title="Help" select="4">
        <div id="guide">
          - Double click left mouse button on the canvas to create shape. <br>
          - Select the shape by pressing left mouse button on it (Esc deselects the elements). <br>
          - Delete the shape by choosing the shape and pressing "D" on the keyboard. <br>
          - Move the shape one layer above/below pressing "-"/"+" on the keyboard. <br>
          - Change the shape color by chosing the shape and chosing the color on the top palette. <br>
          - Change the shape move by chosing the shape and pressing "M" on the keyboard. <br>
          - Move the shape: drag it (click left mouse button and move the mouse). <br>
          - Rotate the shape: hold "r" + drag it. <br>
          - Resize ("escalate") the shape: hold "e" + drag it. <br>
          - Resize the shape (while preserving proportions): hold "e"+"r" + drag it. <br>
          - Resize the shape (normalized): hold "e"+"w" + drag it. <br>
          - Mirror the shape: press "j", maybe in the future we can add different mirror modes. <br>
        </div>
      </tab-wrapper>
    </iron-selector>

    <action-log object="[[letters]]" id="log" on-undo="_undo"></action-log>

    <keyboard-listener on-key-down="_checkKey"></keyboard-listener>

  </template>

  <script>

    class MyApp extends Polymer.Element {
      static get is() {
        return "my-app";
      }

      static get config() {
        return {
          properties: {
            colors: {
              type: Array,
              observer: "colorsChanged"
            },
            letters: {
              type: Array
            },
            coloredScale: {
              type: Array,
              observer: "colorScaleChanged"
            },
            selected: Array
          },
          observers: []
        };
      }

      connectedCallback() {
        super.connectedCallback();
        var start = '[]';
        this.set("letters", JSON.parse(start));
      }

      notifyLetters(e) {
        this.notifyPath("letters");
      }

      addDropShape(e) {
        this.letters.push(e.detail);
        this.notifyPath("letters");
      }

      _undo(e) {
        this.letters = e.detail.state;
      }

      _checkKey(e) {
        e.preventDefault();
        if (e.code === "Enter")
          this.$.clef.turnKeyRight();
        if (e.code === "Tab")
          this.$.clef.turnKeyLeft();
        if (e.code === "Backspace")
          this.$.clef.turnModusRight();
        if (e.code === "Backquote")
          this.$.clef.turnModusLeft();
      }

      _delDrops(e, detail){
        this.letters = this.letters.filter(function(item){
          let i = detail.find(function(select){
            return select.info == item;
          });
          return !i;
        });
        this.notifyPath("letters");
      }

      colorSelected(e) {
        for (let letter of this.selected)
            letter.info.style = e.detail.color;
        this.notifyPath("letters");
      }

      _toneSelected(e) {
        for (let letter of this.selected) {
          letter.info.style = e.detail.tone;
          letter.info.matrix.angle = this.coloredScale[e.detail.tone.substr(-1)].rotation / 180 * Math.PI;
        }
        this.notifyPath("letters");
      }

      colorScaleChanged() {
        for (let i = 0; i < this.coloredScale.length; i++)
          this.style.setProperty('--tone-tone-' + i, this.coloredScale[i].color);
        if (this.letters) {
          this.letters = this.letters.map(function (item) {
            if (item.style.substr(0, 5) !== "color") {
              let i = Number(item.style.replace("tone", ""));
              item.matrix.angle = this.coloredScale[i].rotation / 180 * Math.PI;
            }
            return item;
          }.bind(this));
          this.notifyPath("letters");
        }
      }

      colorsChanged() {
        for (let i = 0; i < this.colors.length; i++)
          this.style.setProperty('--tone-color-' + i, this.colors[i]);
      }

      loadSketch(e) {
        this.letters = JSON.parse(e.detail.json);
        this.notifyPath("letters");
      }

      writeInChanges(e, detail) {
//                this.letters = detail[1];
        this.notifyPath("letters");
      }
    }
    customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>

