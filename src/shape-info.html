<dom-module id="shape-info">
    <template>
        <style>
            :host {
                display: flex;
                position: absolute;
                top: 0;
                left: 0;
                cursor: pointer;
            }
        </style>

        <slot></slot>

    </template>
    <script>
        class ShapeInfo extends Polymer.Element {
            static get is() {
                return "shape-info";
            }

            static get config() {
                return {
                    properties: {
                        mousedown: {
                            type: Boolean,
                            value: false,
                        },
                        counter: Number,
                        matrix: {
                            type: Object,
                            observer: "setTransform"
                        },
                        shift: {
                            type: Boolean,
                            value: false
                        },
                        ctrl: {
                            type: Boolean,
                            value: false
                        },
                        alt: {
                            type: Boolean,
                            value: false
                        }
                    }
                };
            }

            constructor() {
                super();
                this.addEventListener("mousedown", function(e) {
                    this.mousedown = true;
                    window.addEventListener("keydown", this.registerKey.bind(this));
                    window.addEventListener("keyup", this.registerKey.bind(this));
                }.bind(this));
                window.addEventListener("mouseup", function(e) {
                    this.mousedown = false;
                    window.removeEventListener("keydown", this.registerKey.bind(this));
                    window.removeEventListener("keyup", this.registerKey.bind(this));
                }.bind(this));
                window.addEventListener("contextmenu", (e) => e.preventDefault());
                window.addEventListener("mousemove", this.mouseMove.bind(this));
            }

            registerKey(e) {
                if (e.type === "keydown") {
                    switch (e.code) {
                        case "ShiftLeft":
                            this.shift = true;
                            break;
                        case "ControlLeft":
                            this.ctrl = true;
                            break;
                        case "AltLeft":
                            this.alt = true;
                            break;
                    }
                } else if (e.type === "keyup") {
                    switch (e.code) {
                        case "ShiftLeft":
                            this.shift = false;
                            break;
                        case "ControlLeft":
                            this.ctrl = false;
                            break;
                        case "AltLeft":
                            this.alt = false;
                            break;
                    }
                }
            }

            mouseMove(e) {
                if (this.mousedown) {
                    switch (e.which) {
                        case 1:
                            if (this.alt)
                                this.scaleIt(e.movementX,e.movementY);
                            else
                                this.translateIt(e.movementX,e.movementY);
                            break;
                        case 2:
                            this.scaleIt(e.movementX,e.movementY);
                            break;
                        case 3:
                            this.rotateIt(e.x,e.y,e.movementX,e.movementY);
                            break;
                    }
                }
            }

            translateIt(x,y) {
                this.matrix.position.x += x;
                this.matrix.position.y += y;
                this.setTransform();
            }
            
            scaleIt(x,y) {
                let cos = Math.cos(this.matrix.angle);
                let sin = Math.sin(this.matrix.angle);
                let nx = cos*x + sin*y;
                let ny = cos*y - sin*x;
                if (this.ctrl) {
                    var max = (this.matrix.scale.x > this.matrix.scale.y) ? this.matrix.scale.x : this.matrix.scale.y;
                    this.matrix.scale.x = max;
                    this.matrix.scale.y = max;
                    nx = -ny;
                };
                if (this.shift) {
                    let divis = this.matrix.scale.x/this.matrix.scale.y;
                    nx = -ny*divis;
                }
                this.matrix.scale.x += nx/20;
                this.matrix.scale.y -= ny/20;
                this.setTransform();
            }

            rotateIt(x,y,dx,dy) {
                var rect = this.querySelector("drop-shape").getBoundingClientRect();
                var center = {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                };
                var dist = {
                    x: x - center.x,
                    y: y - center.y
                };
                var distOld = {
                    x: (x-dx) - center.x,
                    y: (y-dy) - center.y
                };
                let angleDiff = (Math.atan2(dist.y, dist.x) - Math.atan2(distOld.y, distOld.x));
                this.matrix.angle += angleDiff;
                this.matrix.angle = (2*Math.PI+this.matrix.angle)%(2*Math.PI);
                this.setTransform();
            }

            setTransform() {
                let m = this.matrix;
                let angle = m.angle;
                if (this.shift)
                    angle = Math.round(m.angle*(6/Math.PI))/(6/Math.PI);
                let matrix = [
                    m.scale.x*Math.cos(angle),
                    m.scale.x*Math.sin(angle),
                    -m.scale.y*Math.sin(angle),
                    m.scale.y*Math.cos(angle),
                    m.position.x,
                    m.position.y
                ];
                this.style.transform = "matrix("+matrix.join(',')+")";
                // this.notifyChange();
            }

            // notifyChange() {
            //     this.dispatchEvent(new CustomEvent("newinfo", {detail: {counter: this.counter, matrix: this.matrix}}));
            // }
        }
        customElements.define(ShapeInfo.is, ShapeInfo);
    </script>
</dom-module>
