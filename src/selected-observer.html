<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="selected-observer">
  <script>
    class SquareBox {
      constructor(boxes, angle) {
        this.angle = angle;
        this.isSingle = boxes.length == 1;
        for (let next of boxes) {
          this.left = Math.min(this.left || Number.MAX_VALUE, next.left);
          this.top = Math.min(this.top || Number.MAX_VALUE, next.top);
          this.right = Math.max(this.right || -Number.MAX_VALUE, next.right);
          this.bottom = Math.max(this.bottom || -Number.MAX_VALUE, next.bottom);
        }
        this.width = this.right - this.left;
        this.height = this.bottom - this.top;
        this.center = {};
        this.center.x = this.left + this.width / 2;
        this.center.y = this.top + this.height / 2;
      }
    }

    class SelectedObserver extends Polymer.Element {
      static get is() {
        return "selected-observer";
      }

      static get config() {
        return {
          properties: {
            selected: {
              type: Array,
              notify: true
            },
            box: {
              type: SquareBox,
              computed: "_makeBox(selected)",
              notify: true
            }
          }
        }
      }

      connectedCallback() {
        this.selector = this.parentNode.querySelector("#dropSelector");
        this.mutationObservers = {};
        var addRemoveFromSelectorObserver = new MutationObserver(function (mutations) {
          for (let mutation of mutations) {
            for (let node of mutation.addedNodes) {
              if (node instanceof HTMLElement && node.hasAttribute("data-selectable"))
                this.addToObservableList(node);
            }
            for (let node of mutation.removedNodes) {
              if (node instanceof HTMLElement && node.hasAttribute("data-selectable"))
                this.removeFromObservableList(node);
              this.set("selected", this.selector.querySelectorAll("drop-shape[data-selected]"));
            }
          }
        }.bind(this));
        addRemoveFromSelectorObserver.observe(this.selector, {childList: true});
      }

      addToObservableList(node) {
        this.mutationObservers[node.id] = new MutationObserver(this.toggleSelected.bind(this));
        this.mutationObservers[node.id].observe(node, {attributes: true, attributeOldValue: true});
      }

      //todo not sure i need to clean this up??
      removeFromObservableList(node) {
        this.mutationObservers[node.id].disconnect();
        delete this.mutationObservers[node.id];
      }

      toggleSelected(mutations) {
        let newSearch = false;
        for (let mutation of mutations) {
          if (mutation.attributeName == "data-selected")
            newSearch = true;
        }
        if (newSearch)
          this.selected = this.selector.querySelectorAll("drop-shape[data-selected]");
        this.notifyPath("selected");
      }

      _makeBox(items) {
        if (!items || items.length == 0)
          return null;
        let boxes = [];
        for (let el of items)
          boxes.push(el.getBoundingClientRect());
        let angle = (items && items.length == 1) ? items[0].info.angle : 0;
        return new SquareBox(boxes, angle);
      }
    }
    customElements.define(SelectedObserver.is, SelectedObserver);
  </script>
</dom-module>