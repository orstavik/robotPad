<dom-module id="grow-button">
    <template>
        <style>
            :host {
                display: inline-block;
                pointer-events: none;
            }
            #mainCircle {
                display: flex;
                width: var(--grow-button-size);
                height: var(--grow-button-size);
                margin: 10px;
                align-items: center;
                justify-content: center;
                background-color: var(--grow-button-color);
                border-radius: 50%;
                cursor: pointer;
                opacity: 1;
                pointer-events: auto;
                transition: box-shadow 0.2s, opacity 0.2s, background-color 0.3s;
            }
            #mainCircle[hidden]{
                opacity: 0;
                pointer-events: none;
            }
            #mainCircle > iron-icon {
                --iron-icon-width: calc(var(--grow-button-size) * 0.5);
                --iron-icon-height: calc(var(--grow-button-size) * 0.5);
                --iron-icon-fill-color: var(--grow-button-icon-color);
            }
            #outerBox {
                display: flex;
                box-sizing: border-box;
                max-height: 600px;
                position: absolute;
                border-radius: 3px;
                pointer-events: none;
                opacity: 0;
                overflow: hidden;
                z-index: 10;
            }
            #outerBox[expanded] {
                pointer-events: auto;
                z-index: 1000;
            }
            #shadyCircle {
                width: var(--grow-button-size);
                height: var(--grow-button-size);
                position: absolute;
                border-radius: 50%;
                background-color: var(--grow-button-color);
                will-change: transform;
                pointer-events: none;
                z-index: -1;
                transition: background-color 0.3s;
            }
            #shadyCircle[expanded] {
                background-color: white;
            }
            #boxContent {
                opacity: 0;
            }
            #closeButton {
                position: absolute;
                top: 0;
                right: 0;
                z-index: 10;
            }
        </style>

        <paper-material id="mainCircle" elevation=1 on-click="_toggleState" hidden="[[active]]">
            <paper-ripple></paper-ripple>
            <iron-icon icon="[[icon]]"></iron-icon>
        </paper-material>
        
        <paper-material id="outerBox" elevation=0 expanded$="[[active]]">
            <paper-material id="shadyCircle" expanded$="[[active]]"></paper-material>
            <div id="boxContent">
                <paper-icon-button id="closeButton" icon="clear" on-tap="_disActive"></paper-icon-button>
                <slot></slot>
            </div>
        </paper-material>
    
    </template>
    <script>
        class GrowButton extends Polymer.Element {
            static get is() {
                return "grow-button";
            }

            static get config() {
                return {
                    properties: {
                        active: {
                            type: Boolean,
                            value: false,
                            reflectToAttribute: true,
                            notify: true,
                            observer: "_applyState"
                        },
                        icon: String,
                        childs: Array
                    }
                }
            }

            _toggleState(e) {
                this.active = !this.active;
            }

            _disActive() {
                this.active = false;
            }

            _applyState(active) {
                if (active) {
                    this.$.mainCircle.elevation = 2;
                    if (!this.boxSet) this._positionCard();
                    this._expandCard(300);
                } else {
                    this.$.mainCircle.elevation = 1;
                    this._collapseCard(300);
                }
            }

            _expandCard(dur) {
                let box = this.$.outerBox;
                let circle = this.$.shadyCircle;
                let content = this.$.boxContent;
                if (!this.scale) {
                    var bRect = box.getBoundingClientRect();
                    var cRect = circle.getBoundingClientRect();
                    var diagonal = Math.sqrt(bRect.height*bRect.height+bRect.width*bRect.width);
                    this.scale = diagonal/cRect.width*2;
                };
                this.boxAppear = box.animate({opacity: [0, 1]}, {
                    duration: 0,
                    fill: "forwards"
                });
                this.circleGrow = circle.animate({transform: ["scale(1)", "scale("+this.scale+")"]}, {
                    duration: dur,
                    fill: "forwards",
                    easing: "cubic-bezier(0.4, 0, 0.2, 1)"
                });
                this.contentShow = content.animate({opacity: [0,1], transform: ["translateY(-6px)", "translateY(0)"]}, {
                    delay: dur/3,
                    duration: dur/3*2,
                    fill: "forwards",
                    easing: "ease-out"
                });
                setTimeout(function() {
                    box.elevation = 2;
                }.bind(this), dur/2);
            }

            _collapseCard(dur) {
                this.$.outerBox.animate({opacity: [1, 0]}, {
                    duration: dur/3,
                    fill: "forwards"
                });
                this.$.boxContent.animate({opacity: [1,0]}, {
                    duration: 0,
                    fill: "forwards"
                });
                this.$.outerBox.elevation = 0;
            }

            _positionCard() {
                let rect = this.getBoundingClientRect();
                if (rect.left < 50) {
                    this.$.outerBox.style.right = "";
                    this.$.shadyCircle.style.right = "";
                    this.$.outerBox.style.left = "10px";
                    this.$.shadyCircle.style.left = "0";
                } else {
                    this.$.outerBox.style.right = "10px";
                    this.$.shadyCircle.style.right = "0";
                    this.$.outerBox.style.left = "";
                    this.$.shadyCircle.style.left = "";
                }
                if (rect.top < 50) {
                    this.$.outerBox.style.bottom = "";
                    this.$.shadyCircle.style.bottom = "";
                    this.$.outerBox.style.top = "10px";
                    this.$.shadyCircle.style.top = "0";
                } else {
                    this.$.outerBox.style.bottom = "10px";
                    this.$.shadyCircle.style.bottom = "0";
                    this.$.outerBox.style.top = "";
                    this.$.shadyCircle.style.top = "";
                }
                this.boxSet = true;
            }
        }
        customElements.define(GrowButton.is, GrowButton);
    </script>
</dom-module>