<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="drop-shape.html">
<link rel="import" href="droppad-selector.html">
<link rel="import" href="droppad-canvas-canvas.html">

<dom-module id="droppad-item-marker">
  <template>
    <style>
      :host {
        display: block;
      }

      #marker {
        position: absolute;
        top: 0;
        left: 0;
        width: 100px;
        height: 100px;
        border: 1px dotted grey;
      }
      #nw {
        position: absolute;
        top: -3px;
        left: -3px;
        width: 6px;
        height: 6px;
        background-color: lightgrey;
        border: 1px solid grey;
      }
    </style>
    <div id="marker" style$="left:   [[boundingRect.left]]px;
                             top:    [[boundingRect.top]]px;
                             width:  [[boundingRect.width]]px;
                             height: [[boundingRect.height]]px;">
      <div id="nw"></div>

    </div>
    <template is="dom-repeat" items="[[_clones]]">
      <drop-shape id="copy[[item.number]]" class="copy" info="[[item]]"></drop-shape>
    </template>
  </template>

  <script>
    class DroppadItemMarker extends Polymer.Element {
      static get is() {
        return "droppad-item-marker";
      }

      static get config() {
        return {
          properties: {
            items: Array,
            _clones: {
              type: Array,
              computed: "_makeClones(items)"
            },
            boundingRect: {
              type: Object,
              computed: "_makeBoundingRect(_clones)"
            },
            heldkeys: Array,
            zoom: Number
          }
        }
      }

      //todo There is a conflict with the selected that is problematic.
      //1. the down action is associated with selection.
      //2. so when i press down, i select something.
      //3. when I move the mouse, then i do something else
      //todo make intuitive grab handles on the marker.
      //todo fix the rotation of groups of elements.
      //todo fix the scaling of groups of elements.
      //todo many of the functions should have both individual and group values..

      _makeClones(shapes) {
        return shapes.map(el => el.info.clone());
      }

      _makeBoundingRect(infos) {
        return ShapeInfoObject.getSurroundingSquare(infos);  //getSquare func is also needed for copying
      }

      connectedCallback() {
        this.addEventListener("pointerdown", this._pointerDown.bind(this));
        this.pointermoveListener = this._pointerMove.bind(this);
        this.pointerupListener = this._pointerUp.bind(this);
      }

      _pointerDown(e) {
        this.lastPoint = e;
        this.addEventListener("pointermove", this.pointermoveListener);
        this.addEventListener("pointerup", this.pointerupListener);
        this.setPointerCapture(e.pointerId);
        DroppadItemMarker._cancelPropDefault(e);
      }

      _pointerUp(e) {
        this.dispatchEvent(new CustomEvent("changed", {detail: this._clones}));
        this.set("_clones", []);
        this.lastPoint = null;
        this.releasePointerCapture(e.pointerId);
        this.removeEventListener("pointerup", this.pointerupListener);
        this.removeEventListener("pointermove", this.pointermoveListener);
        DroppadItemMarker._cancelPropDefault(e);
      }

      static _cancelPropDefault(e) {
        e.stopPropagation();
        e.preventDefault();
      }

      _pointerMove(e) {
        let movementX = e.clientX - this.lastPoint.clientX;
        let movementY = e.clientY - this.lastPoint.clientY;
        let yMove = movementY / this.zoom;
        let xMove = movementX / this.zoom;
        if (this.heldKeys["KeyE"] && this.heldKeys["KeyW"])
          this._clones.map(clone => clone.scaleRestrict(movementY));
        else if (this.heldKeys["KeyE"] && this.heldKeys["KeyR"])
          this._clones.map(clone => clone.scaleSquare(movementY));
        else if (this.heldKeys["KeyE"])
          this._clones.map(clone => clone.scaleFree(xMove, yMove));
        else if (this.heldKeys["KeyR"])
          this._clones.map(clone => clone.rotate(movementY));
        else
          this._clones.map(clone => clone.move(xMove, yMove));
        this.notifyPath("_clones", this._clones);
        this.lastPoint = e;
        DroppadItemMarker._cancelPropDefault(e);
      }
    }
    customElements.define(DroppadItemMarker.is, DroppadItemMarker);
  </script>
</dom-module>