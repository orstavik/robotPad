<dom-module id="keyboard-listener">
  <script>

    class KeyEvent {
      constructor(code, start, stop) {
        this.code = code;
        this.start = start;
        this.stop = stop;
        this.duration = stop - start;
      }
    }

    class KeyboardListener extends Polymer.Element {
      static get is() {
        return "keyboard-listener";
      }

      static get config() {
        return {
          properties: {
            prevKeyEvent: Object,
            heldKeys: {
              type: Object,
              notify: true
            },
          }
        }
      }

      connectedCallback() {
        window.addEventListener("keydown", this._keydown.bind(this));
        window.addEventListener("keyup", this._keyup.bind(this));
        this.prevKeyEvent = {};
        this.heldKeys = {};
      }

      _keydown(e) {
        KeyboardListener.preventCertainDefaultAction(e);
        this._fire("key-down", {keyboardEvent: e, heldKeys: this.getHeldKeysRightNow(), code: e.code});
        e.absTime = new Date().getTime();
        if (this.isRepeatKeyEvent(e))
          return;
        if ((Object.keys(this.heldKeys).length === 0) && this.prevKeyEvent.timeStamp) {
          this._fire("key-pause-end", {duration: e.timeStamp - this.prevKeyEvent.timeStamp});
        }
        this.prevKeyEvent = e;
        this.heldKeys[e.code] = e;
        this.notifyPath("heldKeys");
      }

      isRepeatKeyEvent(e) {
        return this.prevKeyEvent.type === e.type && this.prevKeyEvent.code === e.code;
      }

      _keyup(e) {
        KeyboardListener.preventCertainDefaultAction(e);
        this._fire("key-up", {keyboardEvent: e, heldKeys: this.getHeldKeysRightNow(), code: e.code});
        e.absTime = new Date().getTime();
        this.prevKeyEvent = e;
        let correspondingDown = this.heldKeys[e.code];
        if (!correspondingDown)
          return;
        let keyE = new KeyEvent(e.code, correspondingDown.absTime, e.absTime);
        delete this.heldKeys[e.code];
        this.notifyPath("heldKeys");
        this._fire("key-stroke", keyE);
      }

      getHeldKeysRightNow() {
        return Object.keys(this.heldKeys);
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {"composed": true, "bubbles": true, "detail": detail}));
      }

      static preventCertainDefaultAction(e) {
        let c = e.code;
        if (c == "Tab" || c == "Enter" || c == "ShiftLeft" || c == "Backquote" || c == "Backspace")
          e.preventDefault();
        e.stopPropagation();
      }
    }
    customElements.define(KeyboardListener.is, KeyboardListener);
  </script>
</dom-module>