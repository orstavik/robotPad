<link rel="import" href="intertext-draggable.html">
<link rel="import" href="intertext-resizeable.html">
<link rel="import" href="intertext-rotatable.html">

<dom-module id="shape-info">
    <template>
        <style>
            :host {
                display: flex;
                position: absolute;
                top: 0;
                left: 0;
                cursor: pointer;
            }
        </style>

        <slot></slot>

    </template>
    <script>
        class ShapeInfo extends Polymer.Element {
            static get is() {
                return "shape-info";
            }

            static get config() {
                return {
                    properties: {
                        mousedown: {
                            type: Boolean,
                            value: false,
                        },
                        counter: Number,
                        matrix: {
                            type: Object,
                            observer: "setTransform"
                        }
                    }
                };
            }

            constructor() {
                super();
                this.addEventListener("mousedown",
                    function(e) {
                        this.mousedown = true;
                    }
                );
                this.addEventListener("mouseup", 
                    function(e) {
                        this.mousedown = false;
                    }
                );
                window.addEventListener("contextmenu", function(e) {e.preventDefault()});
                window.addEventListener("mouseup", 
                    function(e) {
                        this.mousedown = false;
                    }.bind(this)
                );
                window.addEventListener("mousemove", this.mouseMove.bind(this));
            }

            mouseMove(e) {
                if (this.mousedown) {
                    switch (e.which) {
                        case 1:
                            this.translateIt(e.movementX,e.movementY);
                            break;
                        case 2:
                            this.scaleIt(e.movementX,e.movementY);
                            break;
                        case 3:
                            this.rotateIt(e.x,e.y,e.movementX,e.movementY);
                            break;
                    }
                }
            }

            translateIt(x,y) {
                this.matrix.position.x += x;
                this.matrix.position.y += y;
                this.setTransform();
            }
            
            scaleIt(x,y) {
                let cos = Math.cos(this.matrix.angle);
                let sin = Math.sin(this.matrix.angle);
                let nx = cos*x + sin*y;
                let ny = cos*y - sin*x;
                this.matrix.scale.x += nx/20;
                this.matrix.scale.y -= ny/20;
                this.setTransform();
            }

            rotateIt(x,y,dx,dy) {
                var rect = this.querySelector("drop-shape").getBoundingClientRect();
                var center = {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                };
                var dist = {
                    x: x - center.x,
                    y: y - center.y
                };
                var distOld = {
                    x: (x-dx) - center.x,
                    y: (y-dy) - center.y
                };
                let angleDiff = (Math.atan2(dist.y, dist.x) - Math.atan2(distOld.y, distOld.x));
                this.matrix.angle += angleDiff;
                this.matrix.angle = (2*Math.PI+this.matrix.angle)%(2*Math.PI);
                this.setTransform();
            }

            setTransform() {
                let m = this.matrix;
                let matrix = [
                    m.scale.x*Math.cos(m.angle),
                    m.scale.x*Math.sin(m.angle),
                    -m.scale.y*Math.sin(m.angle),
                    m.scale.y*Math.cos(m.angle),
                    m.position.x,
                    m.position.y
                ];
                this.style.transform = "matrix("+matrix.join(',')+")";
                // this.notifyChange();
            }

            // notifyChange() {
            //     this.dispatchEvent(new CustomEvent("newinfo", {detail: {counter: this.counter, matrix: this.matrix}}));
            // }
        }
        customElements.define(ShapeInfo.is, ShapeInfo);
    </script>
</dom-module>
