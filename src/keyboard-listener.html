<dom-module id="keyboard-listener">
  <script>
    class ComplexKeyEvent {
      constructor(prev, e) {
        prev = prev || {heldKeys: {}};
        this.heldKeys = Object.assign({}, prev.heldKeys);
        this.prev = prev;
      }

      getPreviousDown() {
        const p = this.getPreviousUnique();
        return p instanceof KeyDownEvent ? p : p.getPreviousDown();
      }

      getPreviousUp() {
        const p = this.getPreviousUnique();
        return p instanceof KeyUpEvent ? p : p.getPreviousUp();
      }


      getDurationToLastDifferent() {
        const previousUnique = this.getPreviousUnique();
        const x = previousUnique.down || previousUnique.up;
        return this.down.timeStamp - x.timeStamp;
      }

      noHeldKeys() {
        this.heldKeys.length == 0;
      }
    }

    class KeyUpEvent extends ComplexKeyEvent{
      constructor(prev, e) {
        super(prev,e);
        this.up(e);
      }

      up(e) {
        this.up = e;
        this.down = this.heldKeys[e.code];
        if (this.down)
          delete this.heldKeys[e.code];
      }

      getDurationOfKeyStroke() {
        return this.up.timeStamp - this.down.timeStamp;
      }

      getPreviousUnique() {
        return this.prev;
      }

      getTime(){
        return this.up.timeStamp;
      }
    }

    class KeyDownEvent extends ComplexKeyEvent{
      constructor(prev, e) {
        super(prev,e);
        this.down(e);
      }

      down(e) {
        this.down = e;
        if (!this.heldKeys[e.code])
          this.heldKeys[e.code] = e;
        else
          this.isRepeating = this.heldKeys[e.code];
      }

      isRepeat() {
        return !!this.isRepeating;
      }

      getPreviousUnique() {
        return this.isRepeat() ?
          this.prev.getPreviousUnique() :
          this.prev;
      }

      getTime(){
        return this.up.timeStamp;
      }
    }

    class KeyboardListener extends Polymer.Element {
      static get is() {
        return "keyboard-listener";
      }

      static get config() {
        return {
          properties: {
            cachedEvent: ComplexKeyEvent,
            excludeRepeats: {
              type: Boolean,
              value: false
            }
          }
        }
      }

      connectedCallback() {
        window.addEventListener("keydown", this._keydown.bind(this));
        window.addEventListener("keyup", this._keyup.bind(this));
        this.cachedEvent = new ComplexKeyEvent(null);
      }

      _keydown(e) {
        KeyboardListener.preventCertainDefaultAction(e);
        let nowEvent = new KeyDownEvent(this.cachedEvent, e);
        if (!this.excludeRepeats || !nowEvent.isRepeat())
          this._fire("key-down", nowEvent);
      }

      _keyup(e) {
        KeyboardListener.preventCertainDefaultAction(e);
        let nowEvent = new KeyUpEvent(this.cachedEvent, e);
        this._fire("key-up", nowEvent);
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {"composed": true, "bubbles": true, "detail": detail}));
      }

      static preventCertainDefaultAction(e) {
        let c = e.code;
        if (c == "Tab" || c == "Enter" || c == "ShiftLeft" || c == "Backquote" || c == "Backspace")
          e.preventDefault();
        e.stopPropagation();
      }
    }
    customElements.define(KeyboardListener.is, KeyboardListener);
  </script>
</dom-module>