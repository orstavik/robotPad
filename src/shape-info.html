<dom-module id="shape-info">
  <template>
    <style>
      :host {
        display: flex;
        position: absolute;
        top: 50%;
        left: 50%;
        cursor: pointer;
      }
    </style>

    <slot></slot>

  </template>
  <script>
    class ShapeInfoObject {
      constructor(x, y) {
        this.style = 0;
        this.matrix = {
          position: {
            x: x,
            y: y
          },
          scale: {
            x: 1,
            y: 1
          },
          angle: 0
        };
        this.zIndex = 0;
        this.centered = true;
      }

      makeCopy(x, y) {
        let c = new ShapeInfoObject(x, y);
        c.style = this.style;
        c.centered = this.centered;
        c.matrix.scale.x = this.matrix.scale.x;
        c.matrix.scale.y = this.matrix.scale.y;
        c.matrix.position.x += this.matrix.position.x;
        c.matrix.position.y += this.matrix.position.y;
        return c;
      }

      //2*PI = 360gr
      rotate(deg){
        this.matrix.angle = (2 * Math.PI + (this.matrix.angle + deg / 50)) % (2 * Math.PI);
      }

      move(x, y) {
        this.matrix.position.x += x;
        this.matrix.position.y += y;
      }

      scaleSquare(y){
        this.matrix.scale.x = this.matrix.scale.y = this.matrix.scale.y + y/20;
      }

      scaleRestrict(y){
        let divis = this.matrix.scale.x / this.matrix.scale.y;
        this.matrix.scale.x += y/30*divis;
        this.matrix.scale.y += y/30;
      }

      scaleFree(x, y) {
        let cos = Math.cos(this.matrix.angle);
        let sin = Math.sin(this.matrix.angle);
        let nx = cos * x + sin * y;
        let ny = cos * y - sin * x;
        this.matrix.scale.x += nx / 20;
        this.matrix.scale.y -= ny / 20;
      }

      mirror(){
        this.matrix.scale.x *= -1;
      }
    }

    class ShapeInfo extends Polymer.Element {
      static get is() {
        return "shape-info";
      }

      static get config() {
        return {
          properties: {
            info:  Object,
            matrix: {
              type: Array,
              computed: "calcMatrix(info.matrix.angle, info.matrix.position.x, info.matrix.position.y, info.matrix.scale.x, info.matrix.scale.y)"
            },
            shift: {
              type: Boolean,
              value: false
            },
            ctrl: {
              type: Boolean,
              value: false
            },
            alt: {
              type: Boolean,
              value: false
            },
            dataSelected: {
              type: Boolean,
              observer: "changeSelected"
            }
          }
        };
      }

      connectedCallback() {
        this.keyListener = this.registerKey.bind(this);
        this.moveListener = this.mouseMove.bind(this);
      }

      changeSelected() {
        if (this.dataSelected)
          this.select();
        else
          this.deselect();
        this.notifyInfo();
      }

      select() {
        window.addEventListener("keydown", this.keyListener);
        window.addEventListener("keyup", this.keyListener);
        window.addEventListener("mousemove", this.moveListener);
        this.shift = false;
        this.ctrl = false;
        this.alt = false;
      }

      deselect() {
        window.removeEventListener("keydown", this.keyListener);
        window.removeEventListener("keyup", this.keyListener);
        window.removeEventListener("mousemove", this.moveListener);
        this.shift = false;
        this.ctrl = false;
        this.alt = false;
      }

      registerKey(e) {
        let value = (e.type == "keydown");
        switch (e.code) {
          case "KeyR":
            this.shift = value;
            return;
          case "KeyE":
            this.ctrl = value;
            return;
          case "KeyW":
            this.alt = value;
            return;
        }
        if (!value && e.code == "KeyM")
          this.info.mirror();
        else if (!value && e.code == "KeyN")
          this.info.centered = !this.info.centered;
        else if (!value && e.code == "PageUp")
          this.info.zIndex += 1;
        else if (!value && e.code == "PageDown")
          this.info.zIndex -= 1;
        this.notifyInfo();
      }

      notifyInfo() {
        this.dispatchEvent(new CustomEvent("info-updated", null));
      }

      mouseMove(e) {
        if (e.which != 1 || !this.dataSelected)
          return;

        if (this.ctrl && this.alt)
          this.info.scaleRestrict(e.movementY);
        else if (this.ctrl && this.shift)
          this.info.scaleSquare(e.movementY);
        else if (this.ctrl)
          this.info.scaleFree(e.movementX, e.movementY);
        else if (this.shift)
          this.info.rotate(e.movementY);
        else
          this.info.move(e.movementX, e.movementY);
        this.notifyInfo();
      }

      calcMatrix(angle, posX, posY, scX, scY) {
        let matrix = [scX * Math.cos(angle), scX * Math.sin(angle), -scY * Math.sin(angle), scY * Math.cos(angle), posX, posY];
        this.style.transform = "matrix(" + matrix.join(',') + ")";
        return matrix;
      }
    }
    customElements.define(ShapeInfo.is, ShapeInfo);
  </script>
</dom-module>
