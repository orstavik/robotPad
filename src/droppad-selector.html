<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="droppad-selector">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <slot></slot>
  </template>

  <script>
    class DroppadSelector extends Polymer.Element {
      static get is() {
        return "droppad-selector";
      }

      static get config() {
        return {
          properties: {
            selectedElements: {
              type: Array,
              notify: true
            }
          }
        }
      }

      connectedCallback() {
        this.selectedElements = [];
        this.addEventListener("pointerdown", this._pointerDown.bind(this));
        this.pointerUpListener  = this._mouseUp.bind(this);
      }

      select(el) {
        if (el.dataset.selected)
          return;
        el.setAttribute("data-selected", true);
        this.selectedElements.push(el);
        this.notifyPath("selectedElements");
      }

      deselect(el) {
        let pos = this.selectedElements.indexOf(el);
        if (pos == -1)
          throw new Error("wtf, should not happen");
        let item = this.selectedElements.splice(pos, 1); //obs: alters the array of this.selectedElements
        item[0].removeAttribute("data-selected");
        this.notifyPath("selectedElements");
      }

      deselectAll() {
        this.selectedElements.map(function (item) {
          item.removeAttribute("data-selected");
        });
        this.selectedElements = [];
        this.notifyPath("selectedElements");
      }

//      toggleSelect(el) {
//        return el.dataset.selected ? this.deselect(el) : this.select(el);
//      }

      abort() {
        if (this.actions)
          this.actions.abort = true;
      }

      _pointerDown(e) {
        this.addEventListener("mouseup", this.pointerUpListener);
        let el = e.target;
        this.actions = {shift: e.shiftKey, el: el, wasSelectedAlready: el.dataset.selected};
        this.select(el);
      }

      _mouseUp(e) {
        if (!this.actions) {
          //something has triggered this while it shouldnt..
        } else if (this.actions.abort) {

        } else if (this.actions.shift && !this.actions.wasSelectedAlready) {

        } else if (!this.actions.wasSelectedAlready) {
          this.deselectAll();
          this.select(this.actions.el);
        } else {
          this.deselect(this.actions.el);
        }
      }
    }
    customElements.define(DroppadSelector.is, DroppadSelector);
  </script>
</dom-module>