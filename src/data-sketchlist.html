<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="data-sketchlist">
  <script>
    class DataSketchlist extends Polymer.Element {
      static get is() {
        return "data-sketchlist";
      }

      static get config() {
        return {
          properties: {
            sketchList: {
              type: Array,
              notify: true
            },
            sketchid: {
              type: String,
              notify: true
            }
          }
        };
      }

      connectedCallback() {
        this.updateSketchlistFunc = function (snap) { this.set("sketchList", snap.val()); }.bind(this);
        this._db = firebase.app("droppad").database();
      }

      signOut() {
        this.offSketchlistListener();
        this.set("sketchList", []);
      }

      signIn(uid) {
        this.offSketchlistListener();
        this.dbListener = this._db.ref("/users/" + uid + "/sketchlist/");
        this.dbListener.on("value", this.updateSketchlistFunc);
      }

      offSketchlistListener() {
        if (!this.dbListener)
          return;
        this.dbListener.off("value", this.updateSketchlistFunc);
        this.dbListener = null;
      }

      deleteSketch(sketchid, uid) {
        const updates = {};
        updates["sketches/" + sketchid] = null;
        updates["/users/" + uid + "/sketchlist/" + sketchid] = null;
        return this._db.ref().update(updates, function () {
          this.systemMessage("sketch#" + sketchid + " is successfully deleted on server.");
        }.bind(this));
      }

      newSketch(uid) {
        let sketchid = this._db.ref("/users/" + uid + "/sketchlist/").push().key;
        let startValue = {
          name: DataSketchlist.generateSketchName(),
          created: firebase.database.ServerValue.TIMESTAMP
        };
        let updates = {};
        updates["/users/" + uid + "/sketchlist/" + sketchid] = startValue;
        updates["/sketches/" + sketchid] = {created: firebase.database.ServerValue.TIMESTAMP};
        this._db.ref().update(updates, function () {
          this.set("sketchid", sketchid);
          this.systemMessage("sketch#" + sketchid + " is successfully created on server.");
        }.bind(this));
      }

      renameSketch(sketchid, uid, newName) {
        let ref = this._db.ref("/users/" + uid + "/sketchlist/" + sketchid + "/name");
        ref.set(newName, function () {
          this.systemMessage("sketch#" + sketchid + " is successfully renamed on server to: " + newName);
        }.bind(this));
      }

      systemMessage(txt) {
        this.dispatchEvent(new CustomEvent("system-message", {composed: true, bubbles: true, detail: txt}));
      }

      static generateSketchName() {
        let date = new Date();
        return "Sketch_" + date.getDate() + "." + date.getMonth() + "." + date.getFullYear();
      }
    }
    customElements.define(DataSketchlist.is, DataSketchlist);
  </script>
</dom-module>