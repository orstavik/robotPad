<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="drop-shape.html">
<link rel="import" href="droppad-selector.html">
<link rel="import" href="droppad-canvas-canvas.html">
<link rel="import" href="droppad-item-marker.html">

<dom-module id="droppad-canvas">
  <template>
    <style>
      :host {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
      }

      drop-shape[data-selected] {
        box-shadow: 0 0 3px 0px black;
      }

    </style>
    <droppad-canvas-canvas center="{{position}}" zoom="{{zoom}}" on-new-shape="_newShape" on-deselect="_deselectAll">
      <droppad-selector id="dropSelector" selected-elements="{{selectedDrops}}">
        <template is="dom-repeat" items="[[drops]]">
          <drop-shape id="drop[[item.number]]" info="[[item]]"></drop-shape>
        </template>
      </droppad-selector>
      <droppad-item-marker id="square" items="[[selectedDrops]]" on-pointer-move="_selectedMoving"></droppad-item-marker>
    </droppad-canvas-canvas>
  </template>

  <script>
    class ShapeInfoObject {
      constructor(x, y) {
        this.number = ShapeInfoObject.generateId();
        this.style = "no";
        this.x = x;
        this.y = y;
        this.w = 1;
        this.h = 1;
        this.angle = 0;
        this.zIndex = 1000;
        this.centered = true;
      }

      clone() {
        return Object.assign(new ShapeInfoObject(0, 0), this); //this correctly overwrite the new number, as it should do.
      }

      makeCopy(x, y) {
        let c = this.clone();
        c.number = ShapeInfoObject.generateId();
        c.x += x;
        c.y += y;
        return c;
      }

      //2*PI = 360gr
      rotate(deg) {
        this.angle = (2 * Math.PI + (this.angle + deg / 50)) % (2 * Math.PI);
      }

      move(x, y) {
        this.x += x;
        this.y += y;
      }

      scaleSquare(y) {
        this.w = this.h = this.h + y / 20;
      }

      scaleRestrict(y) {
        const divis = this.w / this.h;
        this.w += y / 30 * divis;
        this.h += y / 30;
      }

      scaleFree(x, y) {
        let cos = Math.cos(this.angle);
        let sin = Math.sin(this.angle);
        let nx = cos * x + sin * y;
        let ny = cos * y - sin * x;
        this.w += nx / 20;
        this.h -= ny / 20;
      }

      mirror() {
        this.w *= -1;
      }

      center() {
        this.centered = !this.centered;
      }

      zUp() {
        this.zIndex += 1;
      }

      zDown() {
        this.zIndex -= 1;
      }

      setStyle(styleName) {
        this.style = styleName;
      }

      update(value) {
        Object.assign(this, value);
      }

      getAngle() {
        let angle = this.angle;
        if (this.style.startsWith("tone"))
          angle = 0;
        return angle;
      }

      cssMatrix() {
        let angle = this.getAngle();
        let matrix = [
          this.w * Math.cos(angle),
          this.w * Math.sin(angle),
          -this.h * Math.sin(angle),
          this.h * Math.cos(angle),
          this.x,
          this.y];
        return "matrix(" + matrix.join(',') + ")";
      }

      static generateId() {
        return ShapeInfoObject.__sessionID++;
      }
    }
    ShapeInfoObject.__sessionID = new Date().getTime();

    class ImmutableArrayFunctions {
      static push(array, obj) {
        array = array.slice();
        array.push(obj);
        return array;
      }

      static filter(array, numbers) {
        return array.filter(function (item) {
          return numbers.indexOf(item.number) == -1;
        });
      }

      //todo 10 times slower.. sometimes
      static alterSlow(array, numbers, func, arg1, arg2) {
        array = array.map(function (item) {
          if (numbers.indexOf(item.number) == -1)
            return item;
          item = item.clone();
          return func.call(item, arg1, arg2);
        });
        return array;
      }

      static alter(array, numbers, func, arg1, arg2) {
        let toBeAltered = [];
        array = array.map(function (item) {
          if (numbers.indexOf(item.number) == -1)
            return item;
          item = item.clone();
          toBeAltered.push(item);
          return item;
        });
        toBeAltered.map(function (item) {
          return func.call(item, arg1, arg2);
        });
        return array;
      }

      //todo it looks like Stringify is 2x as slow as parse(?!).
      static testJSONstringifyParseSpeed() {
        let start = new Date().getTime();
        console.log("test1: " + start);
        let ar = [];
        for (var i = 0; i < 100000; i++) {
          ar[i] = JSON.stringify(start);
        }
        let stop = new Date().getTime();
        console.log("test1: " + (stop - start));
        start = stop;
        console.log("test2: " + start);
        for (var j = 0; j < 100000; j++) {
          ar[100000 + j] = JSON.parse(ar[j]);
        }
        stop = new Date().getTime();
        console.log("test2: " + (stop - start));
      }

      static testSpeed(count) {
        let start = new Date().getTime();
        console.log("speed 1: " + start);
        let ar = [];
        for (var i = 0; i < count; i++) {
          ar[i] = new ShapeInfoObject(i, i);
        }
        let stop = new Date().getTime();
        console.log("speed 1: " + (stop - start));

        let number = Math.floor(count / 10);
        let selected = [0, number * 1, number * 3, number * 5, number * 7, number * 2, number * 4, number * 6, number * 8, number * 9];

        start = stop;
        console.log("speed 2: " + start);
        ar = ImmutableArrayFunctions.alter(ar, selected, ShapeInfoObject.prototype.scaleFree, -10, 10);
        stop = new Date().getTime();
        console.log("speed 2: " + (stop - start));

        start = stop;
        console.log("speed 3: " + start);
        ar = ImmutableArrayFunctions.alterSlow(ar, selected, ShapeInfoObject.prototype.scaleFree, -10, 10);
        stop = new Date().getTime();
        console.log("speed 3: " + (stop - start));
      }
    }

    class DroppadCanvas extends Polymer.Element {
      static get is() {
        return "droppad-canvas";
      }

      static get config() {
        return {
          properties: {
            drops: {
              type: Array,
              notify: true
            },
            selectedDrops: {
              type: Array,
              notify: true
            },
            selectedIds: {
              type: Array,
              notify: true,
              computed: "_setSelectedIds(selectedDrops)"
            },
            heldKeys: Array,
            history: {
              type: Array,
              value: function () {
                return [];
              },
              notify: true
            }
          }
        }
      }

      _setSelectedIds(elems) {
        return elems.map(item => item.info.number);
      }

      handleKeyPress(e) {
        if (e.code === "Escape")
          this.$.dropSelector.deselectAll();
        else if (e.code === "Digit0" && this.heldKeys["ControlLeft"])
          this.zoom = 1;
        else if (e.code === "KeyD") {
          this._deleteElem();
          this.$.dropSelector.deselectAll();
        } else if (e.code === "KeyC")
          this.copiedShapes = this.selectedDrops.slice();
        else if (e.code === "KeyV") {
          for (let i = 0; i < this.copiedShapes.length; i++) {
            this._addElem(this.copiedShapes[i].info.makeCopy(this.position.x, this.position.y));
          }
        }
        else if (e.code == "KeyM")
          this.alterSelected(ShapeInfoObject.prototype.mirror);
        else if (e.code == "KeyN")
          this.alterSelected(ShapeInfoObject.prototype.center);
        else if (e.code == "PageUp")
          this.alterSelected(ShapeInfoObject.prototype.zUp);
        else if (e.code == "PageDown")
          this.alterSelected(ShapeInfoObject.prototype.zDown);
      }

      _selectedMoving(e) {
        e.movementX = e.detail.x;
        e.movementY = e.detail.y;
        let yMove = e.movementY / this.zoom;
        let xMove = e.movementX / this.zoom;
        if (this.heldKeys["KeyE"] && this.heldKeys["KeyW"])
          this.alterSelected(ShapeInfoObject.prototype.scaleRestrict, e.movementY );
        else if (this.heldKeys["KeyE"] && this.heldKeys["KeyR"])
          this.alterSelected(ShapeInfoObject.prototype.scaleSquare, e.movementY );
        else if (this.heldKeys["KeyE"])
          this.alterSelected(ShapeInfoObject.prototype.scaleFree, xMove, yMove);
        else if (this.heldKeys["KeyR"])
          this.alterSelected(ShapeInfoObject.prototype.rotate, e.movementY);
        else
          this.alterSelected(ShapeInfoObject.prototype.move, xMove, yMove);
      }

      addStyleToSelected(styleName) {
        this.alterSelected(ShapeInfoObject.prototype.setStyle, styleName);
      }

      updateShape(id, value) {
        this.$.dropSelector.deselectAll();
        this.select(id);
        this.alterSelected(ShapeInfoObject.prototype.update, value);
      }

      select(id) {
        this.$.dropSelector.select(this.shadowRoot.querySelector("#drop" + id));
      }

      _deselectAll() {
        this.$.dropSelector.deselectAll();
      }

      _newShape(e) {
        let shape = new ShapeInfoObject(e.detail.x, e.detail.y);
        this._addElem(shape);
        if (!e.shiftKey)
          this.$.dropSelector.deselectAll();
        setTimeout(function () {
          this.select(shape.number);
        }.bind(this), 0);
      }

      loadSketch(drops) {
        this.set("drops", drops);
      }

      alterSelected(func, arg1, arg2) {
        this.history.push(this.drops);
        this.$.dropSelector.abort();
        this.set("drops", ImmutableArrayFunctions.alter(this.drops, this.selectedIds, func, arg1, arg2));
      }

      _deleteElem() {
        this.history.push(this.drops);
        this.set("drops", ImmutableArrayFunctions.filter(this.drops, this.selectedIds));
      }

      _addElem(shapeInfoObj) {
        this.history.push(this.drops);
        this.set("drops", ImmutableArrayFunctions.push(this.drops, shapeInfoObj));
      }
    }
    customElements.define(DroppadCanvas.is, DroppadCanvas);
  </script>
</dom-module>