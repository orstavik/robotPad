<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<dom-module id="shape-links">
    <template>
        <style>
            :host {
                display: block;
                position: fixed;
                right: 0;
                top: 0;
            }

            img, input {
                width: 14px;
                height: 14px;
            }

            input.name {
                width: 50px;
            }

            input.link {
                width: 400px;
            }
        </style>

        <firebase-document app-name="linksonfire"
                           id="firefire"
                           path="/linksGoHere"
                           data="{{links}}">
        </firebase-document>

        <template is="dom-repeat" items="[[_toArray(links)]]">
            <div class$="[[item.key]]">
                <img src="[[item.value.link]]" alt="image" on-dblclick="makeElement">
                <input class="name" type="text" value="[[item.value.name]]" on-input="madeChanges"/>:
                <input class="link" type="text" value="[[item.value.link]]" on-input="madeChanges"/> <br/>
            </div>
        </template>
        <!--<button on-click="addRow">Add row</button>-->
    </template>

    <script>

        class ShapeLinks extends Polymer.Element {
            static get is() {
                return "shape-links";
            }

            static get config() {
                return {
                    properties: {
                        links: {
                            type: Object,
                            observer: "runThrough"
                        },
                        localLinks: {
                            type: Object,
                            value: function() {
                                return {}
                            }
                        }
                    },

                    observers: [
                        "doConsoleLog2(ivar)"
                    ]
                };
            }

            constructor() {
                super();
                this.ar = [];
            }

            runThrough() {
                for (var key in this.links) {
                    this.getImageUrl(key);
                }
            }

            getImageUrl(name) {
                var storageRef = firebase.storage().ref();
                var image = storageRef.child("shapes/"+name+".png");
                var self = this;

                image.getDownloadURL()
                    .then(function(url) {
                        self.localLinks[name] = url;
                    })
                    .catch(function(error) {
                        switch (error.code) {
                            case 'storage/object_not_found':
                                console.log("File doesn't exist");
                            break;

                            case 'storage/unauthorized':
                                console.log("User doesn't have permission to access the object");
                            break;

                            case 'storage/canceled':
                                console.log("User canceled the upload");
                            break;

                            case 'storage/unknown':
                                console.log("Unknown error occurred, inspect the server response");
                            break;
                        }
                    });
            }

            addRow() {
                var offset = {
                    name: "shortname",
                    link: "https://www.polymer-project.org/images/logos/p-logo.png"
                };
                this.set("links.created" + new Date().getTime(), offset);
            }

            makeElement(e) {
                var name = e.target.nextElementSibling.value;
                var link = this.localLinks[name];
                this.dispatchEvent(new CustomEvent("nevv", {detail:{link: link, letter: name, position: {x: 200, y: 200}}}));
            }

            _toArray(arrayOrObject) {
                var ar = [];
                for (var k in arrayOrObject)
                    ar.push({key: k, value: arrayOrObject[k]});
                return ar;
            }

            madeChanges(e) {
                var parent = e.target.parentNode;
                var key = parent.classList.toString();
                var name = parent.children[1].value;
                var link = parent.children[2].value;
                this.links[key] = {name: name, link: link};
                console.log(this.links.a.name);
            }
        }

        customElements.define(ShapeLinks.is, ShapeLinks);
    </script>
</dom-module>
