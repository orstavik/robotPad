<dom-module id="keyboard-listener">
  <script>
    class ComplexKeyEvent {
      constructor(prev) {
        prev = prev || {heldKeys: {}};
        this.heldKeys = Object.assign({}, prev.heldKeys);
        this.prev = prev;
      }

      down(e) {
        let c = new ComplexKeyEvent(this);
        c.down = e;
        if (!c.heldKeys[e.code])
          c.heldKeys[e.code] = e;
        return c;
      }

      up(e) {
        let c = new ComplexKeyEvent(this);
        c.up = e;
        c.down = c.heldKeys[e.code];
        if (c.down)
          delete c.heldKeys[e.code];
        return c;
      }

      isRepeat() {
        return this.down && this.prev.down && this.down.code == this.down.prev.code;
      }

      getPreviousUnique() {
        return this.isRepetition() ?
          this.prev.getPreviousUnique() :
          this.prev;
      }

      getPreviousDown() {
        let prevUniq = this.getPreviousUnique();
        return prevUniq.down ? prevUniq : prevUniq.getPreviousDown();
      }

      getPreviousUp() {
        let prevUniq = this.getPreviousUnique();
        return prevUniq.up ? prevUniq : prevUniq.getPreviousUp();
      }

      getDurationToLastDifferent() {
        const previousUnique = this.getPreviousUnique();
        const x = previousUnique.down || previousUnique.up;
        return this.down.timeStamp - x.timeStamp;
      }

      getDurationOfKeyStroke() {
        return this.up.timeStamp - this.down.timeStamp;
      }

      noHeldKeys() {
        this.heldKeys.length == 0;
      }
    }

    class KeyboardListener extends Polymer.Element {
      static get is() {
        return "keyboard-listener";
      }

      static get config() {
        return {
          properties: {
            cachedEvent: ComplexKeyEvent,
            excludeRepeats : {
              type: Boolean,
              value: false
            }
          }
        }
      }

      connectedCallback() {
        window.addEventListener("keydown", this._keydown.bind(this));
        window.addEventListener("keyup", this._keyup.bind(this));
        this.cachedEvent = new ComplexKeyEvent(null);
      }

      _keydown(e) {
        KeyboardListener.preventCertainDefaultAction(e);
        let nowEvent = this.cachedEvent.down(e);
        if (!this.excludeRepeats || !nowEvent.isRepeat())
          this._fire("key-down", nowEvent);
      }

      _keyup(e) {
        KeyboardListener.preventCertainDefaultAction(e);
        this._fire("key-up", this.cachedEvent.up(e));
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {"composed": true, "bubbles": true, "detail": detail}));
      }

      static preventCertainDefaultAction(e) {
        let c = e.code;
        if (c == "Tab" || c == "Enter" || c == "ShiftLeft" || c == "Backquote" || c == "Backspace")
          e.preventDefault();
        e.stopPropagation();
      }
    }
    customElements.define(KeyboardListener.is, KeyboardListener);
  </script>
</dom-module>