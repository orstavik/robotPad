<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="letter-shape.html">
<link rel="import" href="shape-info.html">
<link rel="import" href="shape-keyboard.html">
<link rel="import" href="shape-links.html">
<link rel="import" href="json-object.html">

<dom-module id="my-app">
    <template>
        <style>
            :host {
                display: block;
            }
            json-object {
                position: fixed;
                top: 0;
                left: 0;
            }
            #cross {
                position: absolute;
                bottom: 20%;
                left: 20%;
                width: 60%;
                height: 50%;
                border: 1px dotted black;
                border-right: none;
                border-top: none;
            }
        </style>

        <div on-mousedown="setSelect" selectable>
            <div id="cross">&nbsp;</div>

            <shape-links id="links"></shape-links>

            <json-object obj="{{letters}}" on-edited="deepNotifyLetters"></json-object>

            <template is="dom-repeat" items="[[letters]]">
                <shape-info on-propchange="deepNotifyLetters" input="[[item]]" selectable>
                    <letter-shape input="[[item]]" counter="42"></letter-shape>
                </shape-info>
            </template>
        </div>
        <shape-keyboard on-changeprop="updateSelectedElementInfo"></shape-keyboard>
    </template>

    <script>
        Polymer({
            is: 'my-app',
            properties: {
                letters: Array,
                selected: Number
            },
            attached: function(){
                var start= '[{"letter":"yell","color":"crimson","link":' +
                '"http://vignette3.wikia.nocookie.net/thesimssocial/images/b/b3/Dog-Bone-(item).png/revision/latest?cb=20121122020046",' +
                '"position":{"x":211,"y":244}},' +
                '{"letter":"s","color":"red","position":{"x":429,"y":212}},' +
                '{"letter":"t","color":"blue","position":{"x":111,"y":414},"scale":1.8400000000000007,"rotation":62.17591364049903},' +
                '{"letter":"c","color":"green","position":{"x":478,"y":420},"rotation":119.57783868126133}]';
                this.set("letters", JSON.parse(start));
            },
            updateSelectedElementInfo: function (e) {
                this.shadowRoot.querySelector("[selected]").updatePropertyFieldsRelative(e);
                this.deepNotifyLetters();
            },
            deepNotifyLetters: function () {
                this.deepNotify("letters");
            },
            setSelect: function (e) {
                var old = this.$$("[selected]");
                if(old){
                    old.classList.remove("selected");
                    old.removeAttribute("selected");
                }
                var nevv = e.target;
                while(!nevv.hasAttribute("selectable"))
                    nevv = nevv.parentNode || nevv.host;
                nevv.setAttribute("selected", true);
                nevv.classList.add("selected");
                this.deepNotifyLetters();
            },
            hideNames: function () {
                var names = this.shadowRoot.querySelectorAll(".shapeName");
                names.forEach(function (el) {
                    el.style.display = checkbox.checked ? "initial" : "none";
                });
            },
            deepNotify: function (key) {
                this.set(key, JSON.parse(JSON.stringify(this[key])));
//                var tmp = this[key];
//                this.set(key, []);
//                this.set(key, tmp);
            }
        });
    </script>
</dom-module>
