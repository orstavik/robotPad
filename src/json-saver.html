<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<dom-module id="json-saver">
  <template>
    <style>
      :host {
        display: flex;
        height: 100%;
        flex-direction: column;
      }

      #jsonName {
        width: 100px;
      }

      #saveWrapper {
        text-align: left;
        margin-bottom: 20px;
      }

      .jsonWrapper {
        flex-grow: 1;
        overflow-y: scroll;
      }

      .monsterWrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        height: 100%;
      }

      .dropPreview {
        width: 230px;
        height: 150px;
        transform: scale(0.2);
        pointer-events: none;
      }
    </style>

    <firebase-document app-name="droppad"
                       id="firedoc"
                       path="[[jsonPath]]"
                       data="[[jsonString]]">
    </firebase-document>

    <firebase-document app-name="droppad"
                       id="firelist"
                       path="/drop-images"
                       data="{{jsonList}}">
    </firebase-document>

    <div id="saveWrapper">
      <input id="jsonName" value="{{jsonName::input}}"></input>
      <button on-click="saveToFire">Save Sketch</button>
    </div>

    <div class="jsonWrapper">
      <template is="dom-repeat" items="[[_toArray(jsonCopy)]]" id="repeater">
        <div class="monsterWrapper">
          <div class="dropPreview">
            <template is="dom-repeat" items="[[_parseToArray(item.json)]]">
              <shape-info id="drop[[index]]" info="{{item}}" counter="[[index]]" center="[[center]]" data-selectable
                          on-info-updated="anInfoUpdated" style="z-index: [[item.zIndex]]">
                <drop-shape input="[[item]]" centered$="[[item.centered]]"></drop-shape>
              </shape-info>
            </template>
          </div>
          <button class="jsonLoad" on-click="loadIt">[[item.name]]</button>
        </div>
      </template>
    </div>

  </template>

  <script>

    class JsonSaver extends Polymer.Element {
      static get is() {
        return "json-saver";
      }

      static get config() {
        return {
          properties: {
            input: Array,
            jsonPath: String,
            jsonString: String,
            jsonList: {
              type: Object,
              value: function () {
                return {}
              },
              observer: "createCopy"
            },
            jsonName: {
              type: String,
              value: "newSketch",
              notify: true
            },
            jsonCopy: Object,
            jsonArray: Array
          }
        };
      }

      createCopy() {
        var newJSON = JSON.stringify(this.jsonList);
        var oldJSON = JSON.stringify(this.jsonCopy);
        if (oldJSON === newJSON)
          return;
        this.jsonCopy = JSON.parse(newJSON);
      }

      _toArray(obj) {
        var res = [];
        for (var key in obj) {
          res.push({
            name: key,
            json: obj[key]
          });
        }
        return res;
      }

      _parseToArray(str) {
        var res = JSON.parse(str);
        return res;
      }

      saveToFire() {
        this.jsonPath = undefined;
        this.jsonString = undefined;
        this.$.firedoc.disabled = false;
        if (this.jsonName == "newSketch") {
          var timeStamp = new Date().getTime();
          this.jsonPath = "/drop-images/" + timeStamp;
        } else
          this.jsonPath = "/drop-images/" + this.jsonName;
        this.jsonString = JSON.stringify(JSON.parse(JSON.stringify(this.input)));
        this.$.firedoc.disabled = true;
        this.$.jsonName.value = "";
      }

      loadIt(e) {
        var key = e.target.innerText;
        this.dispatchEvent(new CustomEvent("sketchload",
          {
            detail: {
              json: this.jsonCopy[key]
            }
          }
        ));
      }
    }

    customElements.define(JsonSaver.is, JsonSaver);
  </script>
</dom-module>