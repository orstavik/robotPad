<dom-module id="json-saver">
    <template>
        <style>
            :host {
                display: block;
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
            }
            #jsonName {
                width: 100px;
            }
            .jsonWrapper {
                display: flex;
                height: 24vh;
                flex-direction: row;
                flex-wrap: nowrap;
                align-items: flex-end;
                overflow-x: scroll;
            }
            .monsterWrapper {
                display: flex;
                justify-content: center;
                align-items: flex-end;
                position: relative;
                width: 160px;
                height: 100%;
            }
            shape-info {
                pointer-events: none;
                transform: scale(0.2);
                bottom: initial;
                left: initial;
            }
        </style>

        <firebase-document app-name="linksonfire"
                           id="firedoc"
                           path="[[jsonPath]]"
                           data="[[jsonString]]">
        </firebase-document>

        <firebase-document app-name="linksonfire"
                           id="firelist"
                           path="/robots"
                           data="{{jsonList}}">
        </firebase-document>

        <div id="saveWrapper" style="text-align: right">
            <input id="jsonName" value="{{jsonName::input}}"></input>
            <button on-click="saveToFire">Save Sketch</button>
        </div>

        <div class="jsonWrapper">
            <template is="dom-repeat" items="[[_toArray(jsonCopy)]]" id="repeater">
                <div class="monsterWrapper">
                    <template is="dom-repeat" items="[[_parseToArray(item.json)]]">
                        <shape-info key="[[index]]" input="[[item]]" data-selectable on-newinfo="anInfoUpdated">
                            <letter-shape input="[[item]]"></letter-shape>
                        </shape-info>
                    </template>
                    <button class="jsonLoad" on-click="loadIt">[[item.name]]</button>
                </div>
            </template>
        </div>

    </template>

    <script>

        class JsonSaver extends Polymer.Element {
            static get is() {
                return "json-saver";
            }

            static get config() {
                return {
                    properties: {
                        input: Array,
                        jsonPath: String,
                        jsonString: String,
                        jsonList: {
                            type: Object,
                            value: function() {
                                return {}
                            },
                            observer: "createCopy"
                        },
                        jsonCopy: Object,
                        jsonArray: Array
                    }
                };
            }

            createCopy() {
                var newJSON = JSON.stringify(this.jsonList);
                var oldJSON = JSON.stringify(this.jsonCopy);
                if (oldJSON === newJSON)
                    return;
                this.jsonCopy = JSON.parse(newJSON);
            }

            _toArray(obj) {
                var res = []; 
                for (var key in obj) {
                    res.push({
                        name: key,
                        json: obj[key]
                    });
                }
                return res;
            }

            _parseToArray(str) {
                //debugger;
                var res = JSON.parse(str);
                return res;
            }

            saveToFire() {
                this.jsonPath = undefined;
                this.jsonString = undefined;
                this.$.firedoc.disabled = false;
                if (!this.jsonName) {
                    var timeStamp = new Date().getTime();
                    this.jsonPath = "/robots/" + timeStamp;
                } else 
                    this.jsonPath = "/robots/" + this.jsonName;
                this.jsonString = JSON.stringify(this.input);
                this.$.firedoc.disabled = true;
                this.$.jsonName.value = "";
            }

            loadIt(e) {
                var key = e.target.innerText;
                this.dispatchEvent(new CustomEvent("sketchload", 
                    {
                        detail: {
                            json: this.jsonCopy[key]
                        }
                    }
                ));
            }
        }

        customElements.define(JsonSaver.is, JsonSaver);
    </script>
</dom-module>