<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">

<dom-module id="app-ui-namelabel">
  <template>
    <style>
      #paper {
        display: flex;
        position: absolute;
        bottom: 16px;
        right: 16px;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 3px;
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.5s, transform 0.4s;
      }

      #sketchName {
        margin: 4px 12px;
        font-weight: 400;
      }
    </style>

    <template is="dom-if" if="[[uid]]">
        <paper-material id="paper" elevation=1>
          <template is="dom-if" if="[[_hasSketchObject]]">
<!--todo set the color red when the name has not been persisted, and to green when the data is stored in the db-->
            <div id="sketchName" contenteditable="true" on-pointerdown="_stopProp" on-input="_changeSketchName">[[sketchObject.name]]</div>
          </template>
          <template is="dom-if" if="[[!_hasSketchObject]]">
            <div on-click="_newSketch">click to make a new sketch</div>
          </template>
        </paper-material>
    </template>
  </template>
  <script>

    class AppUiNamelabel extends Polymer.Element {
      static get is() {
        return "app-ui-namelabel";
      }

      static get config() {
        return {
          properties: {
            uid: String,
            sketchid: String,
            sketchObject:{
              type: Object
            },
            _hasSketchObject: {
              type: Boolean,
              computed: "_sketchObjectToBool(sketchObject)"
            }
          },
          observers: ["_newUidSketchid(uid, sketchid)"]
        }
      }

      connectedCallback() {
        this._dbListenerFunc = function(snap){ this.set("sketchObject", snap.val());}.bind(this);
      }

      _sketchObjectToBool(sketchObject) {
        return !sketchObject || sketchObject.length == 0 ? false : true; //att! don't replace || with && here
      }

      loadSketch(sketchid){
        this.set("sketchid", sketchid);
      }

      _newUidSketchid(uid, sketchid) {
        if (this.dbListener)
          this.dbListener.off("value", this._dbListenerFunc);
        if (!uid || !sketchid){
          this.set("sketchObject", null);
          return;
        }
        let path = "/users/" + uid + "/sketchlist/" + sketchid;
        this.dbListener = firebase.app("droppad").database().ref(path);
        this.dbListener.on("value", this._dbListenerFunc);
      }

      _newSketch(e) {
        //todo these two set and push operations are not atomic, they should be..
        let db = firebase.app("droppad").database();
        let userDataSketchListPath = "/users/" + this.uid + "/sketchlist";
        let startValue = {
          name: AppUiNamelabel.generateSketchName(),
          created: firebase.database.ServerValue.TIMESTAMP
        };
        let newUserSketch = db.ref(userDataSketchListPath).push(startValue);
        let sketchid = newUserSketch.key;
        let sketchesPath = "/sketches/" + sketchid;
        db.ref(sketchesPath).set({created: firebase.database.ServerValue.TIMESTAMP});
        this.set("sketchid", sketchid);
        this.dispatchEvent(new CustomEvent("new-sketch", {composed: true, bubbles: true, detail: sketchid}));
      }

      _changeSketchName(e) {
        if (this.nameChanger)
          clearTimeout(this.nameChanger);
        this.nameChanger = setTimeout(this.renameSketchOnDB.bind(this, e.target.innerHTML), 3000);
      }

      renameSketchOnDB(newName){
        let db = firebase.app("droppad").database();
        let sketchInfoPath = "/users/" + this.uid + "/sketchlist/" + this.sketchid + "/name" ;
        db.ref(sketchInfoPath).set(newName);
      }

      static generateSketchName() {
        let date = new Date();
        return "Sketch_" + date.getDate() + "." + date.getMonth() + "." + date.getFullYear();
      }

      _stopProp(e){
        e.stopPropagation();
      }
    }
    customElements.define(AppUiNamelabel.is, AppUiNamelabel);
  </script>
</dom-module>