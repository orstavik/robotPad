<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="color-palette.html">
<link rel="import" href="json-object.html">
<link rel="import" href="droppad-history.html">
<link rel="import" href="json-saver.html">
<link rel="import" href="droppad-canvas.html">
<link rel="import" href="tab-wrapper.html">
<link rel="import" href="app-ui.html">
<link rel="import" href="data-sketchlist.html">

<dom-module id="my-app">
  <template>
    <style>
      :host {
        display: block;
        --tone-color-0: blue;
        --tone-color-1: red;
        --tone-color-2: yellow;
        --tone-color-3: grey;
        --tone-color-4: orange;
        --tone-color-5: green;
        --tone-color-6: purple;
        --tone-color-7: darkgreen;
        --tone-color-8: brown;
        --tone-color-9: pink;
        --tone-color-10: teal;
        --tone-color-11: magenta;
        --tone-tone-0: blue;
        --tone-tone-1: red;
        --tone-tone-2: yellow;
        --tone-tone-3: grey;
        --tone-tone-4: orange;
        --tone-tone-5: green;
        --tone-tone-6: purple;
        --tone-rotation-0: rotate(0deg);
        --tone-rotation-1: rotate(0deg);
        --tone-rotation-2: rotate(0deg);
        --tone-rotation-3: rotate(0deg);
        --tone-rotation-4: rotate(0deg);
        --tone-rotation-5: rotate(0deg);
        --tone-rotation-6: rotate(0deg);
        --tone-grey-0: hsl(0, 0%, 0%);
        --tone-grey-1: hsl(0, 0%, 9%);
        --tone-grey-2: hsl(0, 0%, 18%);
        --tone-grey-3: hsl(0, 0%, 27%);
        --tone-grey-4: hsl(0, 0%, 36%);
        --tone-grey-5: hsl(0, 0%, 45%);
        --tone-grey-6: hsl(0, 0%, 54%);
        --tone-grey-7: hsl(0, 0%, 63%);
        --tone-grey-8: hsl(0, 0%, 72%);
        --tone-grey-9: hsl(0, 0%, 81%);
        --tone-grey-10: hsl(0, 0%, 90%);
        --tone-grey-11: hsl(0, 0%, 100%);
      }
    </style>

    <firebase-app auth-domain="robotpad-762de.firebaseapp.com"
                  database-url="https://robotpad-762de.firebaseio.com/"
                  api-key="AIzaSyAJ0HCTXnEXoG_aJ5AcN8d1VLbugeHF-Bo"
                  name="droppad">
    </firebase-app>
    <firebase-auth id="auth" app-name="droppad" user="{{serverUser}}" provider="google"></firebase-auth>
    <data-sketchlist id="sketchlist" sketch-data="{{sketchData}}" on-new-sketch-object="_newSketchObject"></data-sketchlist>
    <droppad-history id="history" on-new-state="_newState" history="{{history}}"></droppad-history>

    <droppad-canvas id="canvasController" drops="[[letters]]" preview="[[preview]]"
                    on-addshapes="_addShapes"
                    on-removeshapes="_removeShapes"
                    on-changeshapes="_changeShapes"
                    on-deselect="_deselect"
    ></droppad-canvas>

    <app-ui id="ui" user="[[user]]" petals="[[letters]]" history="[[history]]" scale="[[scale]]"
            sketch-data="[[sketchData]]"
            on-new-user="_newUserLoggedIn"
            on-load-sketch="_loadSketch"
            on-timetravel="_timetravel"
            on-new-colors="_newColors"
            on-new-color-scale="_newColorScale"
            on-select-color="colorSelected"
            on-sign-in="_signIn"
            on-sign-out="_signOut"
            on-delete-sketch="_deleteSketch"
            on-rename-sketch="_renameSketch"
            on-new-sketch="_newSketch"
    ></app-ui>
  </template>

  <script>

    class MyApp extends Polymer.Element {
      static get is() {
        return "my-app";
      }

      static get config() {
        return {
          properties: {
            user: Object,
            letters: Array,
            sketchData: Object,
            history: history,
            helpText: {
              type: String,
              value: null
            },
            serverUser: {
              type: Object,
              observer: "_serverSignInOrOut"
            }
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();
        this.addEventListener("system-msg", function (e) {
          this.$.ui.showMsg(e.detail, "system");
        }.bind(this));
        this.addEventListener("help-msg", function (e) {
          this.$.ui.showMsg(e.detail, "help");
        }.bind(this));
      }

      _serverSignInOrOut(serverUser) {
        if (serverUser) {
          this.set("user", serverUser);
          this.$.sketchlist.signIn(this.user.uid);
        } else {
          this.set("user", null);
          this.$.sketchlist.signOut();
        }
      }

      _newColors(e) {
        let colors = e.detail;
        for (let i = 0; i < colors.length; i++)
          this.style.setProperty('--tone-color-' + i, colors[i]);
      }

      _newColorScale(e) {
        let coloredScale = e.detail;
        for (let i = 0; i < coloredScale.length; i++) {
          this.style.setProperty('--tone-tone-' + i, coloredScale[i].color);
          this.style.setProperty('--tone-rotation-' + i, "rotate(" + coloredScale[i].rotation + "deg)");
        }
      }

      colorSelected(e) {
        this.$.canvasController.addStyleToSelected(e.detail);
      }

      _newState(e) {
        this.set("letters", e.detail);
        if (!this.sketchData.id)
          return;
        this.$.sketchlist.saveSketch(e.detail);
      }

      _deselect() {
        this.$.ui.deselect();
      }

      _addShapes(e) {
        this.$.history.add(e.detail);
      }

      _removeShapes(e) {
        this.$.history.remove(e.detail);
      }

      _changeShapes(e) {
        this.$.history.update(e.detail);
      }

      _timetravel(e) {
        this.$.canvasController.timeTravel(e.detail);
      }

      _newUserLoggedIn(e) {
        console.log("new user");
      }

      _loadSketch(e) {
        console.log(e);
        this.$.sketchlist.loadSketch(e.detail);
      }

      _signIn() {
        return this.$.auth.signInWithPopup();
      }

      _signOut() {
        return this.$.auth.signOut();
      }

      _deleteSketch(e) {
        this.$.sketchlist.deleteSketch(e.detail.sketch, e.detail.user);
      }

      _newSketchObject(e) {
        this.$.history.load(e.detail);
      }

      _renameSketch(e) {
        this.$.sketchlist.renameSketch(e.detail.sketch, this.user.uid, e.detail.name);
      }

      loadSketch(e) {
        this.$.history.setState(e.detail.json);
      }

      _newSketch() {
        this.$.sketchlist.newSketch(this.user.uid);
//        todo this.$.history.setState([]);
      }

      writeInChanges(e) {
        this.$.canvasController.updateShape(e.target.key, e.detail[e.target.key]);
      }

      setStyleName(e) {
        this.$.canvasController.addStyleToSelected(e.target.id);
      }
    }
    customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>